<script>
/**
 * 共通ユーティリティ関数
 */

const Utils = {
  /**
   * 金額をフォーマット
   */
  formatCurrency(amount) {
    if (amount === null || amount === undefined) return '-';
    return new Intl.NumberFormat('ja-JP', {
      style: 'currency',
      currency: 'JPY',
      minimumFractionDigits: 0,
    }).format(amount);
  },

  /**
   * 数値をカンマ区切りでフォーマット
   */
  formatNumber(num) {
    if (num === null || num === undefined) return '-';
    return new Intl.NumberFormat('ja-JP').format(num);
  },

  /**
   * 日付をフォーマット
   */
  formatDate(date) {
    if (!date) return '-';
    const d = new Date(date);
    if (isNaN(d.getTime())) return '-';
    return d.toLocaleDateString('ja-JP', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
    });
  },

  /**
   * 日時をフォーマット
   */
  formatDateTime(date) {
    if (!date) return '-';
    const d = new Date(date);
    if (isNaN(d.getTime())) return '-';
    return d.toLocaleString('ja-JP', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
    });
  },

  /**
   * サイズをフォーマット
   */
  formatSize(value, unit = 'mm') {
    if (!value && value !== 0) return '-';
    return `${this.formatNumber(value)}${unit}`;
  },

  /**
   * ステータスバッジクラスを取得
   */
  getStatusClass(status) {
    const classMap = {
      '販売中': 'status-available',
      '商談中': 'status-negotiating',
      '販売済み': 'status-sold',
      '棚卸し中': 'status-inventory',
      '削除済み': 'status-deleted',
      '紛失': 'status-deleted',
    };
    return classMap[status] || 'badge-info';
  },

  /**
   * 要素を表示
   */
  show(element) {
    if (typeof element === 'string') {
      element = document.getElementById(element);
    }
    if (element) {
      element.classList.remove('hidden');
    }
  },

  /**
   * 要素を非表示
   */
  hide(element) {
    if (typeof element === 'string') {
      element = document.getElementById(element);
    }
    if (element) {
      element.classList.add('hidden');
    }
  },

  /**
   * 要素の表示/非表示を切り替え
   */
  toggle(element) {
    if (typeof element === 'string') {
      element = document.getElementById(element);
    }
    if (element) {
      element.classList.toggle('hidden');
    }
  },

  /**
   * フォームデータをオブジェクトに変換
   */
  formToObject(form) {
    const formData = new FormData(form);
    const obj = {};
    formData.forEach((value, key) => {
      obj[key] = value;
    });
    return obj;
  },

  /**
   * デバウンス
   */
  debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  },

  /**
   * URLパラメータを取得
   */
  getUrlParams() {
    const params = new URLSearchParams(window.location.search);
    const obj = {};
    params.forEach((value, key) => {
      obj[key] = value;
    });
    return obj;
  },

  /**
   * 金額入力フィールドにカンマ区切りフォーマットを適用
   */
  formatPriceInput(input) {
    input.addEventListener('blur', function() {
      var value = this.value.replace(/,/g, '');
      if (value && !isNaN(value)) {
        this.value = Number(value).toLocaleString();
      }
    });
    input.addEventListener('focus', function() {
      this.value = this.value.replace(/,/g, '');
    });
  },

  /**
   * XSS対策のエスケープ
   */
  escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  },
};

/**
 * トースト通知
 */
const Toast = {
  container: null,

  init() {
    this.container = document.getElementById('toastContainer');
  },

  show(message, type = 'info', duration = 3000) {
    if (!this.container) this.init();

    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;

    this.container.appendChild(toast);

    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateX(100%)';
      setTimeout(() => toast.remove(), 300);
    }, duration);
  },

  success(message) {
    this.show(message, 'success');
  },

  error(message) {
    this.show(message, 'error', 5000);
  },

  warning(message) {
    this.show(message, 'warning', 4000);
  },

  info(message) {
    this.show(message, 'info');
  },
};

/**
 * ローディング
 */
const Loading = {
  overlay: null,

  init() {
    this.overlay = document.getElementById('loadingOverlay');
  },

  show() {
    if (!this.overlay) this.init();
    if (this.overlay) {
      this.overlay.classList.remove('hidden');
    }
  },

  hide() {
    if (!this.overlay) this.init();
    if (this.overlay) {
      this.overlay.classList.add('hidden');
    }
  },
};

/**
 * 確認ダイアログ
 */
const Confirm = {
  show(message, onConfirm, onCancel) {
    const result = window.confirm(message);
    if (result) {
      onConfirm && onConfirm();
    } else {
      onCancel && onCancel();
    }
  },
};

/**
 * サジェスト入力コンポーネント
 */
var SuggestInput = {
  instances: {},

  /**
   * サジェスト入力を初期化
   * @param {string} inputId - テキスト入力要素のID
   * @param {string} dropdownId - ドロップダウン要素のID
   * @param {string[]} suggestions - サジェスト候補の配列
   */
  init: function(inputId, dropdownId, suggestions) {
    var input = document.getElementById(inputId);
    var dropdown = document.getElementById(dropdownId);
    if (!input || !dropdown) return;

    var instance = {
      input: input,
      dropdown: dropdown,
      suggestions: suggestions || [],
      activeIndex: -1,
    };
    this.instances[inputId] = instance;

    // 入力時にフィルタリング
    input.addEventListener('input', function() {
      SuggestInput.showFiltered(inputId);
    });

    // フォーカス時に候補を表示
    input.addEventListener('focus', function() {
      SuggestInput.showFiltered(inputId);
    });

    // キーボード操作
    input.addEventListener('keydown', function(e) {
      var inst = SuggestInput.instances[inputId];
      var items = dropdown.querySelectorAll('.suggest-item');
      if (!items.length) return;

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        inst.activeIndex = Math.min(inst.activeIndex + 1, items.length - 1);
        SuggestInput.updateActive(inputId, items);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        inst.activeIndex = Math.max(inst.activeIndex - 1, 0);
        SuggestInput.updateActive(inputId, items);
      } else if (e.key === 'Enter') {
        if (inst.activeIndex >= 0 && items[inst.activeIndex]) {
          e.preventDefault();
          input.value = items[inst.activeIndex].textContent;
          SuggestInput.hideDropdown(inputId);
          input.dispatchEvent(new Event('change', { bubbles: true }));
        }
      } else if (e.key === 'Escape') {
        SuggestInput.hideDropdown(inputId);
      }
    });

    // 外側クリックで閉じる
    document.addEventListener('click', function(e) {
      if (!input.contains(e.target) && !dropdown.contains(e.target)) {
        SuggestInput.hideDropdown(inputId);
      }
    });
  },

  /**
   * サジェスト候補を更新
   */
  updateSuggestions: function(inputId, suggestions) {
    var inst = this.instances[inputId];
    if (inst) {
      inst.suggestions = suggestions || [];
    }
  },

  /**
   * フィルタリングされた候補を表示
   */
  showFiltered: function(inputId) {
    var inst = this.instances[inputId];
    if (!inst) return;

    var query = inst.input.value.trim().toLowerCase();
    var filtered = inst.suggestions.filter(function(s) {
      return s.toLowerCase().indexOf(query) !== -1;
    });

    inst.activeIndex = -1;
    var dropdown = inst.dropdown;

    // 候補をクリア
    while (dropdown.firstChild) {
      dropdown.removeChild(dropdown.firstChild);
    }

    if (filtered.length === 0) {
      if (query) {
        var noMatch = document.createElement('div');
        noMatch.className = 'suggest-no-match';
        noMatch.textContent = '「' + inst.input.value.trim() + '」を新規入力';
        dropdown.appendChild(noMatch);
      }
    } else {
      filtered.forEach(function(text) {
        var item = document.createElement('div');
        item.className = 'suggest-item';
        item.textContent = text;
        item.addEventListener('mousedown', function(e) {
          e.preventDefault();
          inst.input.value = text;
          SuggestInput.hideDropdown(inputId);
          inst.input.dispatchEvent(new Event('change', { bubbles: true }));
        });
        dropdown.appendChild(item);
      });
    }

    dropdown.classList.remove('hidden');
  },

  /**
   * アクティブアイテムを更新
   */
  updateActive: function(inputId, items) {
    var inst = this.instances[inputId];
    items.forEach(function(item, i) {
      if (i === inst.activeIndex) {
        item.classList.add('active');
        item.scrollIntoView({ block: 'nearest' });
      } else {
        item.classList.remove('active');
      }
    });
  },

  /**
   * ドロップダウンを閉じる
   */
  hideDropdown: function(inputId) {
    var inst = this.instances[inputId];
    if (inst) {
      inst.dropdown.classList.add('hidden');
      inst.activeIndex = -1;
    }
  },
};

// DOMContentLoaded時に初期化
document.addEventListener('DOMContentLoaded', () => {
  Toast.init();
  Loading.init();
});
</script>
