<script>
/**
 * ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
 */

const App = {
  currentPage: 'dashboard',
  masterData: {
    woodTypes: [],
    suppliers: [],
    processors: [],
    storageLocations: [],
    majorCategories: [],
    requiredFields: [],
  },

  /**
   * åˆæœŸåŒ–
   */
  async init() {
    console.log('App initializing...');

    // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
    this.setupNavigation();

    // ã‚µã‚¤ãƒ‰ãƒãƒ¼æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹ã‚’å¾©å…ƒ
    this.restoreSidebarState();

    // ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
    await this.loadMasterData();

    // åˆæœŸãƒšãƒ¼ã‚¸ã®è¡¨ç¤º
    this.navigateTo('dashboard');

    console.log('App initialized');
  },

  /**
   * ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
   */
  setupNavigation() {
    // ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
    document.querySelectorAll('.nav-link').forEach(function(link) {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const page = link.dataset.page;
        App.navigateTo(page);
        App.closeSidebar();
      });
    });

    // ãƒ¢ãƒã‚¤ãƒ«ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
    document.querySelectorAll('.mobile-nav-item').forEach(function(item) {
      item.addEventListener('click', function(e) {
        e.preventDefault();
        const page = item.dataset.page;
        App.navigateTo(page);
      });
    });

    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒˆã‚°ãƒ«
    const menuToggle = document.getElementById('menuToggle');
    if (menuToggle) {
      menuToggle.addEventListener('click', function() {
        App.toggleSidebar();
      });
    }
  },

  /**
   * ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‹é–‰
   */
  toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    if (sidebar) {
      sidebar.classList.toggle('open');
    }
  },

  /**
   * ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹
   */
  closeSidebar() {
    const sidebar = document.getElementById('sidebar');
    if (sidebar) {
      sidebar.classList.remove('open');
    }
  },

  /**
   * ã‚µã‚¤ãƒ‰ãƒãƒ¼æŠ˜ã‚ŠãŸãŸã¿ãƒˆã‚°ãƒ«
   */
  toggleSidebarCollapse() {
    var sidebar = document.getElementById('sidebar');
    var mainContent = document.getElementById('mainContent');
    if (!sidebar) return;

    var isCollapsed = sidebar.classList.toggle('collapsed');
    if (mainContent) {
      mainContent.classList.toggle('sidebar-collapsed', isCollapsed);
    }
    try {
      localStorage.setItem('sidebarCollapsed', isCollapsed ? '1' : '');
    } catch (e) {}
  },

  /**
   * ã‚µã‚¤ãƒ‰ãƒãƒ¼æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹ã‚’å¾©å…ƒ
   */
  restoreSidebarState() {
    try {
      var collapsed = localStorage.getItem('sidebarCollapsed');
      if (collapsed === '1') {
        var sidebar = document.getElementById('sidebar');
        var mainContent = document.getElementById('mainContent');
        if (sidebar) sidebar.classList.add('collapsed');
        if (mainContent) mainContent.classList.add('sidebar-collapsed');
      }
    } catch (e) {}
  },

  /**
   * ãƒšãƒ¼ã‚¸é·ç§»
   */
  navigateTo(page, params = {}) {
    console.log(`Navigating to: ${page}`, params);

    // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã‚’éè¡¨ç¤º
    document.querySelectorAll('.page').forEach((p) => {
      p.classList.add('hidden');
    });

    // æ–°ã—ã„ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼ˆproduct-editã¯product-newã‚’å†åˆ©ç”¨ï¼‰
    const pageId = page === 'product-edit' ? 'product-new' : page;
    const pageElement = document.getElementById(`page-${pageId}`);
    if (pageElement) {
      pageElement.classList.remove('hidden');
    }

    // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
    document.querySelectorAll('.nav-link, .mobile-nav-item').forEach((link) => {
      link.classList.remove('active');
      if (link.dataset.page === page || (page === 'product-edit' && link.dataset.page === 'product-new')) {
        link.classList.add('active');
      }
    });

    // ãƒšãƒ¼ã‚¸å›ºæœ‰ã®åˆæœŸåŒ–å‡¦ç†
    this.initPage(page, params);

    this.currentPage = page;
  },

  /**
   * ãƒšãƒ¼ã‚¸å›ºæœ‰ã®åˆæœŸåŒ–
   */
  async initPage(page, params) {
    switch (page) {
      case 'dashboard':
        await Dashboard.init();
        break;
      case 'products':
        await ProductList.init();
        break;
      case 'product-new':
        await ProductForm.init();
        break;
      case 'product-edit':
        // è£½å“ç·¨é›†ã¯è£½å“ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã‚’å†åˆ©ç”¨ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼‰
        await ProductForm.init(params.productId);
        break;
      case 'product-detail':
        await ProductDetail.init(params.productId);
        break;
      case 'inventory':
        await Inventory.init();
        break;
      case 'masters':
        await Master.init();
        break;
      case 'sales':
        await SalesList.init();
        break;
      case 'reports':
        await Reports.init();
        break;
    }
  },

  /**
   * ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
   */
  async loadMasterData() {
    try {
      // ä¸¦åˆ—ã§ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      const [woodTypes, suppliers, processors, storageLocations, majorCategories, requiredFields] = await Promise.all([
        Api.getWoodTypes().catch(() => []),
        Api.getSuppliers().catch(() => []),
        Api.getProcessors().catch(() => []),
        Api.getStorageLocations().catch(() => []),
        Api.getMajorCategories().catch(() => []),
        Api.getRequiredFields().catch(() => []),
      ]);

      this.masterData = {
        woodTypes: woodTypes || [],
        suppliers: suppliers || [],
        processors: processors || [],
        storageLocations: storageLocations || [],
        majorCategories: majorCategories || [],
        requiredFields: requiredFields || [],
      };

      console.log('Master data loaded:', this.masterData);
    } catch (error) {
      console.error('Failed to load master data:', error);
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦ç©ºã®é…åˆ—ã‚’è¨­å®š
      this.masterData = {
        woodTypes: [],
        suppliers: [],
        processors: [],
        storageLocations: [],
        majorCategories: [],
        requiredFields: [],
      };
      Toast.error('ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  },

  /**
   * ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®š
   */
  populateSelect(selectId, items, valueKey, labelKey, placeholder = 'é¸æŠã—ã¦ãã ã•ã„') {
    const select = document.getElementById(selectId);
    if (!select) return;

    select.innerHTML = `<option value="">${placeholder}</option>`;
    items.forEach((item) => {
      const option = document.createElement('option');
      option.value = item[valueKey];
      option.textContent = item[labelKey];
      select.appendChild(option);
    });
  },

  /**
   * IDã‹ã‚‰ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã®åç§°ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
   */
  getStorageLocationName(id) {
    if (!id) return '-';
    const item = this.masterData.storageLocations.find(l => l.storageLocationId === id);
    return item?.name || id;
  },

  getSupplierName(id) {
    if (!id) return '-';
    const item = this.masterData.suppliers.find(s => s.supplierId === id);
    return item?.name || id;
  },

  getProcessorName(id) {
    if (!id) return '-';
    const item = this.masterData.processors.find(p => p.processorId === id);
    return item?.name || id;
  },

  getWoodTypeName(id) {
    if (!id) return '-';
    const item = this.masterData.woodTypes.find(w => w.woodTypeId === id || w.name === id);
    return item?.name || id;
  },
};

/**
 * ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
 */
const Dashboard = {
  startDate: null,
  endDate: null,
  periodLabel: 'ä»Šæœˆ',

  async init() {
    // åˆæœŸæœŸé–“ã‚’ä»Šæœˆã«è¨­å®š
    this.setThisMonth();
    await this.loadData();
  },

  async refresh() {
    await this.loadData();
  },

  async loadData() {
    try {
      Loading.show();

      // ä¸¦åˆ—ã§ãƒ‡ãƒ¼ã‚¿å–å¾—
      const [inventoryStats, salesStats, recentProducts] = await Promise.all([
        Api.call('getDashboardStats'),
        Api.call('getSalesStats', this.startDate ? this.startDate.toISOString() : null, this.endDate ? this.endDate.toISOString() : null),
        Api.getProducts({}, { page: 1, limit: 6 }),
      ]);

      // åœ¨åº«æŒ‡æ¨™ã‚’è¡¨ç¤º
      this.renderInventoryStats(inventoryStats);

      // è²©å£²æŒ‡æ¨™ã‚’è¡¨ç¤º
      this.renderSalesStats(salesStats);

      // æœ€è¿‘ã®è£½å“ã‚’è¡¨ç¤º
      this.renderRecentProducts(recentProducts?.data || []);

    } catch (error) {
      console.error('Dashboard load error:', error);
      Toast.error('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      Loading.hide();
    }
  },

  renderInventoryStats(stats) {
    if (!stats) return;
    document.getElementById('statTotalInventory').textContent = stats.totalProducts || 0;
    document.getElementById('statAvailableProducts').textContent = stats.availableProducts || 0;
    document.getElementById('statInventoryValue').textContent = Utils.formatCurrency(stats.totalInventoryValue || 0);
  },

  renderSalesStats(stats) {
    if (!stats) {
      document.getElementById('statTotalSalesCount').textContent = '0';
      document.getElementById('statSoldProducts').textContent = '0';
      document.getElementById('statSalesRevenue').textContent = Utils.formatCurrency(0);
      document.getElementById('statSalesProfit').textContent = Utils.formatCurrency(0);
      return;
    }
    document.getElementById('statTotalSalesCount').textContent = stats.totalSales || 0;
    document.getElementById('statSoldProducts').textContent = stats.totalSales || 0;
    document.getElementById('statSalesRevenue').textContent = Utils.formatCurrency(stats.totalRevenue || 0);
    document.getElementById('statSalesProfit').textContent = Utils.formatCurrency(stats.totalProfit || 0);

    // æœŸé–“ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°
    const labelEl = document.getElementById('salesPeriodLabel');
    if (labelEl) {
      labelEl.textContent = `ï¼ˆ${this.periodLabel}ï¼‰`;
    }
  },

  renderRecentProducts(products) {
    var grid = document.getElementById('recentProductsGrid');

    if (!products || products.length === 0) {
      grid.innerHTML = '<p class="text-muted">è£½å“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
      return;
    }

    var html = '';
    for (var i = 0; i < products.length; i++) {
      var p = products[i];
      html += '<div class="card product-card" onclick="App.navigateTo(\'product-detail\', { productId: \'' + p.productId + '\' })">';
      if (p.rawPhotoUrl) {
        html += '<img class="product-card-image" src="' + Utils.escapeHtml(p.rawPhotoUrl) + '" alt="' + Utils.escapeHtml(p.productName) + '" onerror="this.style.display=\'none\'">';
      } else {
        html += '<div class="product-card-placeholder">ğŸ“·</div>';
      }
      html += '<div class="product-card-content">';
      html += '<div class="product-card-name">' + Utils.escapeHtml(p.productName) + '</div>';
      html += '<div class="product-card-info">' + Utils.escapeHtml(p.woodType) + '</div>';
      html += '<div class="product-card-price">' + Utils.formatCurrency(p.sellingPriceIncTax || 0) + '</div>';
      html += '</div>';
      html += '</div>';
    }
    grid.innerHTML = html;
  },

  // æœŸé–“è¨­å®šãƒ¡ã‚½ãƒƒãƒ‰
  onPeriodChange() {
    const period = document.getElementById('dashboardPeriod').value;
    const customRange = document.getElementById('customDateRange');

    if (period === 'custom') {
      customRange.classList.remove('hidden');
      return;
    }

    customRange.classList.add('hidden');

    switch (period) {
      case 'all':
        this.setAllPeriod();
        break;
      case 'thisMonth':
        this.setThisMonth();
        break;
      case 'lastMonth':
        this.setLastMonth();
        break;
      case 'thisYear':
        this.setThisYear();
        break;
    }

    this.loadData();
  },

  setAllPeriod() {
    this.startDate = null;
    this.endDate = null;
    this.periodLabel = 'å…¨æœŸé–“';
  },

  setThisMonth() {
    const now = new Date();
    this.startDate = new Date(now.getFullYear(), now.getMonth(), 1);
    this.endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
    this.periodLabel = 'ä»Šæœˆ';
  },

  setLastMonth() {
    const now = new Date();
    this.startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
    this.endDate = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59);
    this.periodLabel = 'å…ˆæœˆ';
  },

  setThisYear() {
    const now = new Date();
    this.startDate = new Date(now.getFullYear(), 0, 1);
    this.endDate = new Date(now.getFullYear(), 11, 31, 23, 59, 59);
    this.periodLabel = 'ä»Šå¹´';
  },

  applyCustomDateRange() {
    const startInput = document.getElementById('dashboardStartDate').value;
    const endInput = document.getElementById('dashboardEndDate').value;

    if (!startInput || !endInput) {
      Toast.warning('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    this.startDate = new Date(startInput);
    this.endDate = new Date(endInput + 'T23:59:59');

    if (this.startDate > this.endDate) {
      Toast.warning('é–‹å§‹æ—¥ã¯çµ‚äº†æ—¥ã‚ˆã‚Šå‰ã«ã—ã¦ãã ã•ã„');
      return;
    }

    this.periodLabel = `${startInput} ã€œ ${endInput}`;
    this.loadData();
  },
};

/**
 * è£½å“ä¸€è¦§
 */
const ProductList = {
  products: [],
  currentPage: 1,
  limit: 20,
  total: 0,
  selectionMode: false,
  selectedProducts: new Set(),

  async init() {
    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’åˆæœŸåŒ–
    App.populateSelect('filterCategory', App.masterData.majorCategories, 'name', 'name', 'ã™ã¹ã¦ã®åˆ†é¡');
    App.populateSelect('filterStorageLocation', App.masterData.storageLocations, 'storageLocationId', 'name', 'ã™ã¹ã¦ã®ä¿ç®¡å ´æ‰€');
    App.populateSelect('filterWoodType', App.masterData.woodTypes, 'name', 'name', 'ã™ã¹ã¦ã®æ¨¹ç¨®');

    this.setupEventListeners();
    await this.loadProducts();
  },

  setupEventListeners() {
    const searchInput = document.getElementById('searchKeyword');
    if (searchInput) {
      searchInput.addEventListener(
        'input',
        Utils.debounce(function() { ProductList.loadProducts(); }, 300)
      );
    }

    const filterStatus = document.getElementById('filterStatus');
    if (filterStatus) {
      filterStatus.addEventListener('change', function() { ProductList.loadProducts(); });
    }

    const filterCategory = document.getElementById('filterCategory');
    if (filterCategory) {
      filterCategory.addEventListener('change', function() { ProductList.loadProducts(); });
    }

    const filterStorageLocation = document.getElementById('filterStorageLocation');
    if (filterStorageLocation) {
      filterStorageLocation.addEventListener('change', function() { ProductList.loadProducts(); });
    }

    const filterWoodType = document.getElementById('filterWoodType');
    if (filterWoodType) {
      filterWoodType.addEventListener('change', function() { ProductList.loadProducts(); });
    }

    const sizeInputIds = ['filterMinLength', 'filterMaxLength', 'filterMinWidth', 'filterMaxWidth', 'filterMinThickness', 'filterMaxThickness'];
    sizeInputIds.forEach(function(id) {
      var el = document.getElementById(id);
      if (el) {
        el.addEventListener('input', Utils.debounce(function() { ProductList.loadProducts(); }, 500));
      }
    });
  },

  async loadProducts(resetPage) {
    if (resetPage !== false) {
      this.currentPage = 1;
    }
    try {
      Loading.show();

      // æ¤œç´¢æ¡ä»¶ã‚’å–å¾—
      const keyword = document.getElementById('searchKeyword')?.value || '';
      const status = document.getElementById('filterStatus')?.value || '';
      const category = document.getElementById('filterCategory')?.value || '';
      const storageLocationId = document.getElementById('filterStorageLocation')?.value || '';
      const woodType = document.getElementById('filterWoodType')?.value || '';
      const minLength = document.getElementById('filterMinLength')?.value || '';
      const maxLength = document.getElementById('filterMaxLength')?.value || '';
      const minWidth = document.getElementById('filterMinWidth')?.value || '';
      const maxWidth = document.getElementById('filterMaxWidth')?.value || '';
      const minThickness = document.getElementById('filterMinThickness')?.value || '';
      const maxThickness = document.getElementById('filterMaxThickness')?.value || '';

      const conditions = {};
      if (keyword) conditions.keyword = keyword;
      if (status) conditions.statuses = [status];
      if (category) conditions.majorCategories = [category];
      if (storageLocationId) conditions.storageLocationIds = [storageLocationId];
      if (woodType) conditions.woodTypes = [woodType];
      if (minLength || maxLength) {
        conditions.lengthRange = {};
        if (minLength) conditions.lengthRange.min = parseInt(minLength);
        if (maxLength) conditions.lengthRange.max = parseInt(maxLength);
      }
      if (minWidth || maxWidth) {
        conditions.widthRange = {};
        if (minWidth) conditions.widthRange.min = parseInt(minWidth);
        if (maxWidth) conditions.widthRange.max = parseInt(maxWidth);
      }
      if (minThickness || maxThickness) {
        conditions.thicknessRange = {};
        if (minThickness) conditions.thicknessRange.min = parseInt(minThickness);
        if (maxThickness) conditions.thicknessRange.max = parseInt(maxThickness);
      }

      console.log('loadProducts: conditions=', conditions);
      const result = await Api.getProducts(conditions, { page: this.currentPage, limit: this.limit });
      console.log('loadProducts: result=', result);

      this.products = result?.data || [];
      this.total = result?.total || this.products.length;
      this.renderProducts();
    } catch (error) {
      console.error('Failed to load products:', error);
      Toast.error('è£½å“ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || error));
      this.products = [];
      this.total = 0;
      this.renderProducts();
    } finally {
      Loading.hide();
    }
  },

  renderProducts() {
    const grid = document.getElementById('productGrid');
    const countEl = document.getElementById('productCount');

    if (this.products.length === 0) {
      grid.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ“¦</div>
          <div class="empty-state-title">è£½å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>
          <div class="empty-state-text">æ¤œç´¢æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚</div>
        </div>
      `;
      countEl.textContent = '0 ä»¶ã®è£½å“';
      return;
    }

    countEl.textContent = `${this.total} ä»¶ã®è£½å“`;

    var html = '';
    for (var i = 0; i < this.products.length; i++) {
      var p = this.products[i];
      var photoUrl = this.convertDriveUrl(p.rawPhotoUrl);
      var isSelected = this.selectedProducts.has(p.productId);

      if (this.selectionMode) {
        html += '<div class="card product-card selectable' + (isSelected ? ' selected' : '') + '" onclick="ProductList.toggleSelection(\'' + p.productId + '\')" data-product-id="' + p.productId + '">';
        html += '<div class="product-card-checkbox">' + (isSelected ? 'âœ“' : '') + '</div>';
      } else {
        html += '<div class="card product-card" onclick="App.navigateTo(\'product-detail\', { productId: \'' + p.productId + '\' })">';
      }

      if (photoUrl) {
        html += '<img class="product-card-image" src="' + Utils.escapeHtml(photoUrl) + '" alt="' + Utils.escapeHtml(p.productName) + '" onerror="this.style.display=\'none\'">';
      } else {
        html += '<div class="product-card-placeholder">ğŸ“·</div>';
      }
      html += '<div class="product-card-content">';
      html += '<div class="product-card-name">' + Utils.escapeHtml(p.productName) + '</div>';
      html += '<div class="product-card-info">';
      html += Utils.escapeHtml(p.woodType) + ' / ' + Utils.escapeHtml(p.majorCategory);
      html += ' <span class="badge ' + Utils.getStatusClass(p.status) + '" style="margin-left: 8px;">' + p.status + '</span>';
      html += '</div>';
      html += '<div class="product-card-price">' + Utils.formatCurrency(p.sellingPriceIncTax || p.price) + '</div>';
      html += '</div>';
      html += '</div>';
    }
    grid.innerHTML = html;
    this.renderPagination();
  },

  renderPagination() {
    var container = document.getElementById('pagination');
    if (!container) return;
    var totalPages = Math.ceil(this.total / this.limit);
    if (totalPages <= 1) {
      container.innerHTML = '';
      return;
    }
    var current = this.currentPage;
    var html = '';
    // å‰ã¸ãƒœã‚¿ãƒ³
    html += '<button class="pagination-btn" ' + (current <= 1 ? 'disabled' : '') + ' onclick="ProductList.goToPage(' + (current - 1) + ')">&#8249; å‰ã¸</button>';
    // ãƒšãƒ¼ã‚¸ç•ªå·ï¼ˆæœ€å¤§7ãƒšãƒ¼ã‚¸åˆ†è¡¨ç¤ºï¼‰
    var startPage = Math.max(1, current - 3);
    var endPage = Math.min(totalPages, startPage + 6);
    if (endPage - startPage < 6) {
      startPage = Math.max(1, endPage - 6);
    }
    if (startPage > 1) {
      html += '<button class="pagination-btn" onclick="ProductList.goToPage(1)">1</button>';
      if (startPage > 2) html += '<span class="pagination-info">...</span>';
    }
    for (var i = startPage; i <= endPage; i++) {
      html += '<button class="pagination-btn' + (i === current ? ' active' : '') + '" onclick="ProductList.goToPage(' + i + ')">' + i + '</button>';
    }
    if (endPage < totalPages) {
      if (endPage < totalPages - 1) html += '<span class="pagination-info">...</span>';
      html += '<button class="pagination-btn" onclick="ProductList.goToPage(' + totalPages + ')">' + totalPages + '</button>';
    }
    // æ¬¡ã¸ãƒœã‚¿ãƒ³
    html += '<button class="pagination-btn" ' + (current >= totalPages ? 'disabled' : '') + ' onclick="ProductList.goToPage(' + (current + 1) + ')">æ¬¡ã¸ &#8250;</button>';
    // ãƒšãƒ¼ã‚¸æƒ…å ±
    html += '<span class="pagination-info" style="margin-left:8px;">' + current + ' / ' + totalPages + ' ãƒšãƒ¼ã‚¸</span>';
    container.innerHTML = html;
  },

  goToPage(page) {
    var totalPages = Math.ceil(this.total / this.limit);
    if (page < 1 || page > totalPages) return;
    this.currentPage = page;
    this.loadProducts(false);
    // ãƒšãƒ¼ã‚¸ä¸Šéƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    var grid = document.getElementById('productGrid');
    if (grid) grid.scrollIntoView({ behavior: 'smooth', block: 'start' });
  },

  resetFilters() {
    document.getElementById('searchKeyword').value = '';
    document.getElementById('filterStatus').value = '';
    document.getElementById('filterCategory').value = '';
    document.getElementById('filterStorageLocation').value = '';
    document.getElementById('filterWoodType').value = '';
    document.getElementById('filterMinLength').value = '';
    document.getElementById('filterMaxLength').value = '';
    document.getElementById('filterMinWidth').value = '';
    document.getElementById('filterMaxWidth').value = '';
    var minThEl = document.getElementById('filterMinThickness');
    var maxThEl = document.getElementById('filterMaxThickness');
    if (minThEl) minThEl.value = '';
    if (maxThEl) maxThEl.value = '';
    this.loadProducts();
  },

  toggleFilterSidebar() {
    var sidebar = document.getElementById('filterSidebar');
    if (sidebar) {
      sidebar.classList.toggle('open');
    }
  },

  enterSelectionMode() {
    this.selectionMode = true;
    this.selectedProducts = new Set();
    var toolbar = document.getElementById('selectionToolbar');
    if (toolbar) toolbar.classList.remove('hidden');
    var catalogBtn = document.getElementById('catalogModeBtn');
    if (catalogBtn) catalogBtn.classList.add('hidden');
    this.updateSelectionCount();
    this.renderProducts();
  },

  exitSelectionMode() {
    this.selectionMode = false;
    this.selectedProducts = new Set();
    var toolbar = document.getElementById('selectionToolbar');
    if (toolbar) toolbar.classList.add('hidden');
    var catalogBtn = document.getElementById('catalogModeBtn');
    if (catalogBtn) catalogBtn.classList.remove('hidden');
    this.renderProducts();
  },

  toggleSelection(productId) {
    if (this.selectedProducts.has(productId)) {
      this.selectedProducts.delete(productId);
    } else {
      if (this.selectedProducts.size >= 50) {
        Toast.warning('é¸æŠã¯æœ€å¤§50ä»¶ã¾ã§ã§ã™');
        return;
      }
      this.selectedProducts.add(productId);
    }
    // DOMæ›´æ–°ï¼ˆå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã›ãšã«è¦ç´ ã‚’æ›´æ–°ï¼‰
    var card = document.querySelector('[data-product-id="' + productId + '"]');
    if (card) {
      var isSelected = this.selectedProducts.has(productId);
      card.classList.toggle('selected', isSelected);
      var checkbox = card.querySelector('.product-card-checkbox');
      if (checkbox) checkbox.textContent = isSelected ? 'âœ“' : '';
    }
    this.updateSelectionCount();
  },

  updateSelectionCount() {
    var count = this.selectedProducts.size;
    var countEl = document.getElementById('selectionCount');
    if (countEl) countEl.textContent = count + ' ä»¶é¸æŠä¸­';
    var btn = document.getElementById('generateCatalogBtn');
    if (btn) btn.disabled = count === 0;
  },

  async generateCatalogPdf() {
    var ids = Array.from(this.selectedProducts);
    if (ids.length === 0) {
      Toast.warning('è£½å“ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }

    try {
      Loading.show();
      var result = await Api.call('generateCatalogPdf', ids);
      if (result && result.url) {
        window.open(result.url, '_blank');
        Toast.success('ã‚«ã‚¿ãƒ­ã‚°PDFã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼ˆ' + ids.length + 'è£½å“ï¼‰');
      } else {
        Toast.error('PDFç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    } catch (error) {
      console.error('generateCatalogPdf error:', error);
      Toast.error('PDFç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + (error.message || ''));
    } finally {
      Loading.hide();
    }
  },

  // Google Drive URLã‚’å¤‰æ›
  convertDriveUrl(url) {
    if (!url) return null;
    const fileIdMatch = url.match(/\/d\/([a-zA-Z0-9_-]+)|[?&]id=([a-zA-Z0-9_-]+)/);
    if (fileIdMatch) {
      const fileId = fileIdMatch[1] || fileIdMatch[2];
      return 'https://drive.google.com/thumbnail?id=' + fileId + '&sz=w400';
    }
    return url;
  },
};

/**
 * è£½å“ãƒ•ã‚©ãƒ¼ãƒ 
 */
const ProductForm = {
  isEditMode: false,
  editProductId: null,
  processingCosts: [], // åŠ å·¥è²»ãƒªã‚¹ãƒˆ
  processingCostIdCounter: 0, // ä¸€æ™‚IDç”¨ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼

  async init(productId = null) {
    this.isEditMode = !!productId;
    this.editProductId = productId;
    this.processingCosts = [];
    this.processingCostIdCounter = 0;

    // ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
    const titleEl = document.getElementById('formTitle');
    if (titleEl) {
      titleEl.textContent = this.isEditMode ? 'è£½å“ç·¨é›†' : 'è£½å“ç™»éŒ²';
    }

    // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’åˆæœŸåŒ–
    App.populateSelect('woodType', App.masterData.woodTypes, 'name', 'name');
    App.populateSelect('supplierId', App.masterData.suppliers, 'supplierId', 'name');
    App.populateSelect('storageLocationId', App.masterData.storageLocations, 'storageLocationId', 'name');

    // å¤§åˆ†é¡ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’åˆæœŸåŒ–
    App.populateSelect('majorCategory', App.masterData.majorCategories, 'name', 'name');

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('productForm').reset();

    // åŠ å·¥è²»ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
    this.renderProcessingCostsList();

    // ä»Šæ—¥ã®æ—¥ä»˜ã‚’è¨­å®šï¼ˆæ–°è¦ç™»éŒ²æ™‚ã®ã¿ï¼‰
    if (!this.isEditMode) {
      document.getElementById('purchaseDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('profitMargin').value = '60';
      document.getElementById('priceAdjustment').value = '0';
    }

    // å†™çœŸã‚’ãƒªã‚»ãƒƒãƒˆ
    this.setupPhotoPreview();

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆ
    const form = document.getElementById('productForm');
    form.onsubmit = function(e) {
      e.preventDefault();
      ProductForm.submit();
      return false;
    };

    // Enterã‚­ãƒ¼ã§ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚’é˜²æ­¢ï¼ˆtextareaä»¥å¤–ï¼‰
    form.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
        e.preventDefault();
      }
    });

    // ä¾¡æ ¼ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
    this.setupPricePreview();

    // é‡‘é¡å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’é©ç”¨
    ['purchasePrice', 'shippingCost', 'priceAdjustment'].forEach(function(id) {
      var input = document.getElementById(id);
      if (input) {
        Utils.formatPriceInput(input);
      }
    });

    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    if (this.isEditMode) {
      await this.loadProductForEdit(productId);
    }

    // åˆæœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
    this.updatePricePreview();

    // å¿…é ˆé …ç›®ã‚’å‹•çš„ã«é©ç”¨
    this.applyRequiredFields();
  },

  async loadProductForEdit(productId) {
    try {
      Loading.show();
      const product = await Api.getProduct(productId);

      if (!product) {
        Toast.error('è£½å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        App.navigateTo('products');
        return;
      }

      // ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
      document.getElementById('majorCategory').value = product.majorCategory || '';
      document.getElementById('productName').value = product.productName || '';
      document.getElementById('woodType').value = product.woodType || '';
      document.getElementById('storageLocationId').value = product.storageLocationId || '';

      // ã‚µã‚¤ã‚ºæƒ…å ±ï¼ˆãƒã‚¹ãƒˆã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰èª­ã¿å–ã‚Šï¼‰
      document.getElementById('rawLength').value = (product.rawSize && product.rawSize.length) || '';
      document.getElementById('rawWidth').value = (product.rawSize && product.rawSize.width) || '';
      document.getElementById('rawThickness').value = (product.rawSize && product.rawSize.thickness) || '';
      document.getElementById('finishedLength').value = (product.finishedSize && product.finishedSize.length) || '';
      document.getElementById('finishedWidth').value = (product.finishedSize && product.finishedSize.width) || '';
      document.getElementById('finishedThickness').value = (product.finishedSize && product.finishedSize.thickness) || '';

      // ä»•å…¥ã‚Œæƒ…å ±
      document.getElementById('supplierId').value = product.supplierId || '';
      if (product.purchaseDate) {
        const date = new Date(product.purchaseDate);
        document.getElementById('purchaseDate').value = date.toISOString().split('T')[0];
      }
      document.getElementById('purchasePrice').value = product.purchasePrice || '';

      // ä¾¡æ ¼è¨­å®š
      document.getElementById('shippingCost').value = product.shippingCost || '';
      document.getElementById('profitMargin').value = (product.profitMargin != null && product.profitMargin !== '') ? product.profitMargin : '60';
      document.getElementById('priceAdjustment').value = (product.priceAdjustment != null && product.priceAdjustment !== '') ? product.priceAdjustment : '0';

      // å‚™è€ƒ
      document.getElementById('remarks').value = product.remarks || '';

      // é…é€æ¥­è€…
      document.getElementById('shippingCarrier').value = product.shippingCarrier || '';

      // å†™çœŸURLï¼ˆJSONé…åˆ— or å˜ä¸€URLï¼‰
      if (product.rawPhotoUrls) {
        try {
          this.rawPhotos = product.rawPhotoUrls.startsWith('[') ? JSON.parse(product.rawPhotoUrls) : [product.rawPhotoUrls];
        } catch(e) { this.rawPhotos = [product.rawPhotoUrls]; }
        this.renderPhotoThumbnails('raw');
      }
      if (product.finishedPhotoUrls) {
        try {
          this.finishedPhotos = product.finishedPhotoUrls.startsWith('[') ? JSON.parse(product.finishedPhotoUrls) : [product.finishedPhotoUrls];
        } catch(e) { this.finishedPhotos = [product.finishedPhotoUrls]; }
        this.renderPhotoThumbnails('finished');
      }

      // åŠ å·¥è²»ã‚’èª­ã¿è¾¼ã¿
      try {
        const costResult = await Api.getProcessingCosts(productId);
        if (costResult?.costs && costResult.costs.length > 0) {
          this.processingCosts = costResult.costs.map(cost => ({
            tempId: ++this.processingCostIdCounter,
            existingId: cost.processingCostId,
            processingType: cost.processingType,
            processorId: cost.processorId,
            processingContent: cost.processingContent || '',
            amount: cost.amount || 0,
          }));
          this.renderProcessingCostsList();
        }
      } catch (e) {
        console.error('Failed to load processing costs:', e);
      }

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
      this.updatePricePreview();
    } catch (error) {
      console.error('Failed to load product for edit:', error);
      Toast.error('è£½å“ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      Loading.hide();
    }
  },

  setupPricePreview() {
    const fields = ['purchasePrice', 'shippingCost', 'profitMargin', 'priceAdjustment'];
    fields.forEach(function(field) {
      const input = document.getElementById(field);
      if (input) {
        input.oninput = function() { ProductForm.updatePricePreview(); };
      }
    });

    // ä¾¡æ ¼èª¿æ•´é¡ã®ç¨åˆ¥ãƒ»ç¨è¾¼ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³
    document.querySelectorAll('input[name="priceAdjustmentType"]').forEach(function(radio) {
      radio.addEventListener('change', function() { ProductForm.updatePricePreview(); });
    });
  },

  // è¤‡æ•°å†™çœŸç®¡ç†ç”¨çŠ¶æ…‹
  rawPhotos: [],
  finishedPhotos: [],
  MAX_PHOTOS: 5,

  // å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¨­å®šï¼ˆåˆæœŸåŒ–ç”¨ï¼‰
  setupPhotoPreview() {
    this.rawPhotos = [];
    this.finishedPhotos = [];
    this.renderPhotoThumbnails('raw');
    this.renderPhotoThumbnails('finished');
  },

  // Google Drive URLã‚’ç”»åƒURLã«å¤‰æ›
  convertDriveUrl(url) {
    if (!url) return null;
    var fileIdMatch = url.match(/\/d\/([a-zA-Z0-9_-]+)|[?&]id=([a-zA-Z0-9_-]+)/);
    if (fileIdMatch) {
      var fileId = fileIdMatch[1] || fileIdMatch[2];
      return 'https://drive.google.com/thumbnail?id=' + fileId + '&sz=w400';
    }
    return url;
  },

  // ã‚µãƒ ãƒã‚¤ãƒ«ã‚°ãƒªãƒƒãƒ‰ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆUtils.escapeHtmlã§XSSå¯¾ç­–æ¸ˆã¿ï¼‰
  renderPhotoThumbnails(type) {
    var photos = type === 'raw' ? this.rawPhotos : this.finishedPhotos;
    var container = document.getElementById(type + 'PhotoThumbnails');
    if (!container) return;

    // DOMæ“ä½œã§å®‰å…¨ã«ã‚µãƒ ãƒã‚¤ãƒ«ã‚’ç”Ÿæˆ
    container.textContent = '';
    if (photos.length === 0) {
      var placeholder = document.createElement('div');
      placeholder.className = 'photo-preview-placeholder';
      placeholder.style.cssText = 'width:80px;height:80px;font-size:24px;display:flex;align-items:center;justify-content:center;border:1px dashed var(--color-border);border-radius:6px;';
      placeholder.textContent = 'ğŸ“·';
      container.appendChild(placeholder);
    } else {
      photos.forEach(function(url, index) {
        var thumbUrl = ProductForm.convertDriveUrl(url);
        var item = document.createElement('div');
        item.className = 'photo-thumbnail-item';
        var img = document.createElement('img');
        img.src = thumbUrl;
        img.alt = 'å†™çœŸ' + (index + 1);
        img.onerror = function() { item.textContent = 'ã‚¨ãƒ©ãƒ¼'; };
        var btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'photo-thumbnail-remove';
        btn.textContent = 'Ã—';
        btn.onclick = function() { ProductForm.removePhoto(type, index); };
        item.appendChild(img);
        item.appendChild(btn);
        container.appendChild(item);
      });
    }

    // 5æšä¸Šé™ã§ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤º
    var addBtn = document.getElementById(type + 'PhotoAddBtn');
    var cameraBtn = document.getElementById(type + 'PhotoCameraBtn');
    if (addBtn) addBtn.style.display = photos.length >= this.MAX_PHOTOS ? 'none' : '';
    if (cameraBtn) cameraBtn.style.display = photos.length >= this.MAX_PHOTOS ? 'none' : '';
  },

  // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®å‡¦ç†ï¼ˆè¤‡æ•°æšå¯¾å¿œï¼‰
  async handleFileSelect(type, fileList) {
    if (!fileList || fileList.length === 0) return;

    var photos = type === 'raw' ? this.rawPhotos : this.finishedPhotos;
    var remaining = this.MAX_PHOTOS - photos.length;
    if (remaining <= 0) {
      Toast.warning('å†™çœŸã¯æœ€å¤§' + this.MAX_PHOTOS + 'æšã¾ã§ã§ã™');
      return;
    }

    var files = Array.from(fileList).slice(0, remaining);
    if (files.length < fileList.length) {
      Toast.warning('ä¸Šé™ã®ãŸã‚ ' + files.length + ' æšã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™');
    }

    var maxSize = 5 * 1024 * 1024;
    var allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];

    // å…ˆã«å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    for (var i = 0; i < files.length; i++) {
      if (!allowedTypes.includes(files[i].type)) {
        Toast.error((i + 1) + 'ç•ªç›®ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯å¯¾å¿œã—ã¦ã„ãªã„å½¢å¼ã§ã™ã€‚JPEGã€PNGã€WebPã®ã¿å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚');
        return;
      }
      if (files[i].size > maxSize) {
        Toast.error((i + 1) + 'ç•ªç›®ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒ5MBã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚');
        return;
      }
    }

    var uploadingId = type === 'raw' ? 'rawPhotoUploading' : 'finishedPhotoUploading';
    var progressId = type === 'raw' ? 'rawPhotoUploadProgress' : 'finishedPhotoUploadProgress';
    var uploadedCount = 0;

    try {
      document.getElementById(uploadingId).classList.remove('hidden');

      for (var i = 0; i < files.length; i++) {
        var progressEl = document.getElementById(progressId);
        if (progressEl) {
          progressEl.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­... (' + (i + 1) + '/' + files.length + ')';
        }

        var base64Data = await this.fileToBase64(files[i]);
        var pid = this.editProductId || '';
        var pname = (document.getElementById('productName') ? document.getElementById('productName').value : '') || '';
        var photoIndex = photos.length + 1;
        var result = await Api.call('uploadProductPhoto', base64Data, files[i].name, files[i].type, pid, pname, type, photoIndex);

        if (result && result.url) {
          photos.push(result.url);
          this.renderPhotoThumbnails(type);
          uploadedCount++;
        } else {
          Toast.error((i + 1) + 'ç•ªç›®ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      }

      if (uploadedCount > 0) {
        Toast.success(uploadedCount + 'æšã®å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼ˆ' + photos.length + '/' + this.MAX_PHOTOS + 'æšï¼‰');
      }
    } catch (error) {
      console.error('File upload error:', error);
      Toast.error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + (error.message || ''));
    } finally {
      document.getElementById(uploadingId).classList.add('hidden');
      var progressEl = document.getElementById(progressId);
      if (progressEl) progressEl.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';
      var fileInput = document.getElementById(type + 'PhotoFile');
      var cameraInput = document.getElementById(type + 'PhotoCamera');
      if (fileInput) fileInput.value = '';
      if (cameraInput) cameraInput.value = '';
    }
  },

  // å†™çœŸã‚’å‰Šé™¤ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æŒ‡å®šï¼‰
  removePhoto(type, index) {
    var photos = type === 'raw' ? this.rawPhotos : this.finishedPhotos;
    photos.splice(index, 1);
    this.renderPhotoThumbnails(type);
    Toast.info('å†™çœŸã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
  },

  // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Base64ã«å¤‰æ›
  fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => {
        // Data URLã‹ã‚‰ã€Œdata:image/xxx;base64,ã€éƒ¨åˆ†ã‚’é™¤å»
        const base64 = reader.result.split(',')[1];
        resolve(base64);
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  },

  updatePricePreview() {
    const purchasePrice = parseFloat((document.getElementById('purchasePrice')?.value || '').replace(/,/g, '')) || 0;
    const shippingCost = parseFloat((document.getElementById('shippingCost')?.value || '').replace(/,/g, '')) || 0;
    const profitMargin = parseFloat(document.getElementById('profitMargin')?.value) || 60;
    const priceAdjustmentRaw = parseFloat((document.getElementById('priceAdjustment')?.value || '').replace(/,/g, '')) || 0;

    // ä¾¡æ ¼èª¿æ•´é¡ã®ç¨åˆ¥ãƒ»ç¨è¾¼åˆ¤å®š
    const adjustmentTypeEl = document.querySelector('input[name="priceAdjustmentType"]:checked');
    const adjustmentType = adjustmentTypeEl ? adjustmentTypeEl.value : 'exTax';
    const priceAdjustment = adjustmentType === 'incTax' ? Math.round(priceAdjustmentRaw / 1.1) : priceAdjustmentRaw;

    // åŠ å·¥è²»åˆè¨ˆã‚’è¨ˆç®—
    const processingCostTotal = this.getProcessingCostsTotal();

    // ãƒˆãƒ¼ã‚¿ãƒ«åŸä¾¡
    const totalCost = purchasePrice + processingCostTotal + shippingCost;

    // ç›®å®‰è²©å£²ä¾¡æ ¼ï¼ˆåˆ©ç›Šç‡ãŒ100%ã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼å›é¿ï¼‰
    const marginRate = Math.min(profitMargin, 99) / 100;
    const suggestedPrice = marginRate < 1 ? Math.round(totalCost / (1 - marginRate)) : totalCost;

    // è²©å£²ä¾¡æ ¼ï¼ˆç¨æŠœï¼‰
    const priceExTax = suggestedPrice + priceAdjustment;

    // è²©å£²ä¾¡æ ¼ï¼ˆç¨è¾¼ï¼‰
    const priceIncTax = Math.round(priceExTax * 1.1);

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
    const setPreview = (id, value) => {
      const el = document.getElementById(id);
      if (el) el.textContent = value;
    };

    setPreview('previewPurchasePrice', Utils.formatCurrency(purchasePrice));
    setPreview('previewProcessingCost', Utils.formatCurrency(processingCostTotal));
    setPreview('previewShippingCost', Utils.formatCurrency(shippingCost));
    setPreview('previewTotalCost', Utils.formatCurrency(totalCost));
    setPreview('previewSuggestedPrice', Utils.formatCurrency(suggestedPrice));
    setPreview('previewSuggestedPriceInc', Utils.formatCurrency(Math.round(suggestedPrice * 1.1)));
    setPreview('previewPriceAdjustment', Utils.formatCurrency(priceAdjustment));
    setPreview('previewPriceAdjustmentInc', Utils.formatCurrency(Math.round(priceAdjustment * 1.1)));
    setPreview('previewPriceExTax', Utils.formatCurrency(priceExTax));
    setPreview('previewPriceIncTax', Utils.formatCurrency(priceIncTax));
  },

  // åŠ å·¥è²»åˆè¨ˆã‚’å–å¾—
  getProcessingCostsTotal() {
    return this.processingCosts.reduce((sum, cost) => sum + (cost.amount || 0), 0);
  },

  // åŠ å·¥è²»è¡Œã‚’è¿½åŠ 
  addProcessingCostRow() {
    const tempId = ++this.processingCostIdCounter;
    this.processingCosts.push({
      tempId,
      existingId: null,
      processingType: '',
      processorId: '',
      processingContent: '',
      amount: 0,
    });
    this.renderProcessingCostsList();
  },

  // åŠ å·¥è²»è¡Œã‚’å‰Šé™¤
  removeProcessingCostRow(tempId) {
    this.processingCosts = this.processingCosts.filter(c => c.tempId !== tempId);
    this.renderProcessingCostsList();
    this.updatePricePreview();
  },

  // åŠ å·¥è²»ãƒªã‚¹ãƒˆã‚’æç”»
  renderProcessingCostsList() {
    var container = document.getElementById('processingCostsList');
    if (!container) return;

    if (this.processingCosts.length === 0) {
      container.innerHTML = '<p class="text-muted">åŠ å·¥è²»ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>';
      return;
    }

    var html = '';
    for (var i = 0; i < this.processingCosts.length; i++) {
      var cost = this.processingCosts[i];
      html += '<div class="card mb-md" style="padding: var(--spacing-md);">';
      html += '<div class="form-row form-row-2">';
      html += '<div class="form-group">';
      html += '<label class="form-label">åŠ å·¥ç¨®åˆ¥</label>';
      html += '<select class="form-select" onchange="ProductForm.updateProcessingCost(' + cost.tempId + ', \'processingType\', this.value)">';
      html += '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
      html += '<option value="ã‚«ãƒ³ãƒŠ"' + (cost.processingType === 'ã‚«ãƒ³ãƒŠ' ? ' selected' : '') + '>ã‚«ãƒ³ãƒŠ</option>';
      html += '<option value="ä¹¾ç‡¥"' + (cost.processingType === 'ä¹¾ç‡¥' ? ' selected' : '') + '>ä¹¾ç‡¥</option>';
      html += '<option value="å¡—è£…"' + (cost.processingType === 'å¡—è£…' ? ' selected' : '') + '>å¡—è£…</option>';
      html += '<option value="è„šå–ã‚Šä»˜ã‘"' + (cost.processingType === 'è„šå–ã‚Šä»˜ã‘' ? ' selected' : '') + '>è„šå–ã‚Šä»˜ã‘</option>';
      html += '<option value="ç ”ç£¨"' + (cost.processingType === 'ç ”ç£¨' ? ' selected' : '') + '>ç ”ç£¨</option>';
      html += '<option value="è£œä¿®"' + (cost.processingType === 'è£œä¿®' ? ' selected' : '') + '>è£œä¿®</option>';
      html += '<option value="æœ¨æåŠ å·¥"' + (cost.processingType === 'æœ¨æåŠ å·¥' ? ' selected' : '') + '>æœ¨æåŠ å·¥</option>';
      html += '<option value="ãã®ä»–"' + (cost.processingType === 'ãã®ä»–' ? ' selected' : '') + '>ãã®ä»–</option>';
      html += '</select>';
      html += '</div>';
      html += '<div class="form-group">';
      html += '<label class="form-label">åŠ å·¥æ¥­è€…</label>';
      html += '<select class="form-select" onchange="ProductForm.updateProcessingCost(' + cost.tempId + ', \'processorId\', this.value)">';
      html += '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
      for (var j = 0; j < App.masterData.processors.length; j++) {
        var p = App.masterData.processors[j];
        html += '<option value="' + p.processorId + '"' + (cost.processorId === p.processorId ? ' selected' : '') + '>' + Utils.escapeHtml(p.name) + '</option>';
      }
      html += '</select>';
      html += '</div>';
      html += '</div>';
      html += '<div class="form-row form-row-2">';
      html += '<div class="form-group">';
      html += '<label class="form-label">åŠ å·¥å†…å®¹</label>';
      html += '<input type="text" class="form-input" value="' + Utils.escapeHtml(cost.processingContent || '') + '" onchange="ProductForm.updateProcessingCost(' + cost.tempId + ', \'processingContent\', this.value)" placeholder="ä»»æ„">';
      html += '</div>';
      html += '<div class="form-group">';
      html += '<label class="form-label">é‡‘é¡ï¼ˆç¨æŠœï¼‰</label>';
      html += '<div class="flex gap-sm">';
      html += '<input type="text" class="form-input processing-cost-amount" inputmode="numeric" value="' + (cost.amount ? Number(cost.amount).toLocaleString() : '') + '" onchange="ProductForm.updateProcessingCost(' + cost.tempId + ', \'amount\', parseInt(this.value.replace(/,/g, \'\')) || 0)" placeholder="å††">';
      html += '<button type="button" class="btn btn-danger btn-sm" onclick="ProductForm.removeProcessingCostRow(' + cost.tempId + ')">å‰Šé™¤</button>';
      html += '</div>';
      html += '</div>';
      html += '</div>';
      html += '</div>';
    }
    container.innerHTML = html;

    // åŠ å·¥è²»ã®é‡‘é¡ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’é©ç”¨
    container.querySelectorAll('.processing-cost-amount').forEach(function(input) {
      Utils.formatPriceInput(input);
    });
  },

  // åŠ å·¥è²»ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
  updateProcessingCost(tempId, field, value) {
    const cost = this.processingCosts.find(c => c.tempId === tempId);
    if (cost) {
      cost[field] = value;
      if (field === 'amount') {
        this.updatePricePreview();
      }
    }
  },

  collectFormData() {
    // ã‚µã‚¤ã‚ºæƒ…å ±ã‚’å–å¾—ï¼ˆç©ºã®å ´åˆã¯undefinedï¼‰
    const rawLength = document.getElementById('rawLength').value;
    const rawWidth = document.getElementById('rawWidth').value;
    const rawThickness = document.getElementById('rawThickness').value;
    const finishedLength = document.getElementById('finishedLength').value;
    const finishedWidth = document.getElementById('finishedWidth').value;
    const finishedThickness = document.getElementById('finishedThickness').value;

    const rawSize = (rawLength || rawWidth || rawThickness) ? {
      length: rawLength ? parseInt(rawLength) : undefined,
      width: rawWidth ? parseInt(rawWidth) : undefined,
      thickness: rawThickness ? parseInt(rawThickness) : undefined,
    } : undefined;

    const finishedSize = (finishedLength || finishedWidth || finishedThickness) ? {
      length: finishedLength ? parseInt(finishedLength) : undefined,
      width: finishedWidth ? parseInt(finishedWidth) : undefined,
      thickness: finishedThickness ? parseInt(finishedThickness) : undefined,
    } : undefined;

    // å†™çœŸURLï¼ˆJSONé…åˆ—ï¼‰
    var rawPhotoUrls = this.rawPhotos.length > 0 ? JSON.stringify(this.rawPhotos) : undefined;
    var finishedPhotoUrls = this.finishedPhotos.length > 0 ? JSON.stringify(this.finishedPhotos) : undefined;

    // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
    return {
      majorCategory: document.getElementById('majorCategory').value,
      productName: document.getElementById('productName').value.trim(),
      woodType: document.getElementById('woodType').value,
      rawSize: rawSize,
      finishedSize: finishedSize,
      rawPhotoUrls: rawPhotoUrls,
      finishedPhotoUrls: finishedPhotoUrls,
      supplierId: document.getElementById('supplierId').value,
      purchaseDate: document.getElementById('purchaseDate').value,
      purchasePrice: parseInt(document.getElementById('purchasePrice').value.replace(/,/g, '')) || 0,
      storageLocationId: document.getElementById('storageLocationId').value,
      shippingCost: parseInt(document.getElementById('shippingCost').value.replace(/,/g, '')) || undefined,
      profitMargin: document.getElementById('profitMargin').value !== '' ? parseFloat(document.getElementById('profitMargin').value) : 60,
      priceAdjustment: (function() {
        var raw = parseInt(document.getElementById('priceAdjustment').value.replace(/,/g, '')) || 0;
        var typeEl = document.querySelector('input[name="priceAdjustmentType"]:checked');
        var type = typeEl ? typeEl.value : 'exTax';
        return type === 'incTax' ? Math.round(raw / 1.1) : raw;
      })(),
      remarks: document.getElementById('remarks').value.trim() || undefined,
      shippingCarrier: document.getElementById('shippingCarrier').value.trim() || undefined,
    };
  },

  // å¿…é ˆé …ç›®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚­ãƒ¼ã¨ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ IDã®ãƒãƒƒãƒ”ãƒ³ã‚°
  FIELD_LABEL_MAP: {
    majorCategory: 'å¤§åˆ†é¡',
    productName: 'å•†å“å',
    woodType: 'æ¨¹ç¨®',
    storageLocationId: 'ä¿ç®¡å ´æ‰€',
    supplierId: 'ä»•å…¥ã‚Œå…ˆ',
    purchaseDate: 'ä»•å…¥ã‚Œæ—¥',
    purchasePrice: 'å…¥è·å˜ä¾¡',
    rawLength: 'å…¥è·æ™‚ é•·ã•',
    rawWidth: 'å…¥è·æ™‚ å¹…',
    rawThickness: 'å…¥è·æ™‚ åšã¿',
    finishedLength: 'ä»•ä¸Šã’å¾Œ é•·ã•',
    finishedWidth: 'ä»•ä¸Šã’å¾Œ å¹…',
    finishedThickness: 'ä»•ä¸Šã’å¾Œ åšã¿',
    shippingCost: 'è²©å£²æ™‚é€æ–™',
    profitMargin: 'åˆ©ç›Šç‡',
    remarks: 'å‚™è€ƒ',
  },

  // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚­ãƒ¼ã‹ã‚‰ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®ãƒ‘ã‚¹ã‚’è§£æ±º
  resolveFieldValue(data, fieldKey) {
    var sizeMap = {
      rawLength: function() { return data.rawSize ? data.rawSize.length : null; },
      rawWidth: function() { return data.rawSize ? data.rawSize.width : null; },
      rawThickness: function() { return data.rawSize ? data.rawSize.thickness : null; },
      finishedLength: function() { return data.finishedSize ? data.finishedSize.length : null; },
      finishedWidth: function() { return data.finishedSize ? data.finishedSize.width : null; },
      finishedThickness: function() { return data.finishedSize ? data.finishedSize.thickness : null; },
    };
    if (sizeMap[fieldKey]) return sizeMap[fieldKey]();
    return data[fieldKey];
  },

  applyRequiredFields() {
    var requiredFields = App.masterData.requiredFields || [];
    var allFieldKeys = Object.keys(this.FIELD_LABEL_MAP);

    for (var i = 0; i < allFieldKeys.length; i++) {
      var key = allFieldKeys[i];
      var el = document.getElementById(key);
      if (!el) continue;

      var isRequired = requiredFields.indexOf(key) >= 0;
      if (isRequired) {
        el.setAttribute('required', '');
      } else {
        el.removeAttribute('required');
      }

      // ãƒ©ãƒ™ãƒ«ã®å¿…é ˆãƒãƒ¼ã‚¯
      var label = el.closest('.form-group')?.querySelector('.form-label');
      if (label) {
        if (isRequired) {
          label.classList.add('form-label-required');
        } else {
          label.classList.remove('form-label-required');
        }
      }
    }
  },

  validateFormData(data) {
    var errors = [];
    var requiredFields = App.masterData.requiredFields || [];

    // å‹•çš„å¿…é ˆãƒã‚§ãƒƒã‚¯
    for (var i = 0; i < requiredFields.length; i++) {
      var fieldKey = requiredFields[i];
      var label = this.FIELD_LABEL_MAP[fieldKey];
      if (!label) continue;

      var value = this.resolveFieldValue(data, fieldKey);
      if (value == null || value === '' || value === undefined) {
        errors.push(label + 'ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      }
    }

    // å•†å“åã®é•·ã•ãƒã‚§ãƒƒã‚¯ï¼ˆå¿…é ˆã«é–¢ã‚ã‚‰ãšå…¥åŠ›ãŒã‚ã‚‹å ´åˆï¼‰
    if (data.productName && data.productName.length > 100) {
      errors.push('å•†å“åã¯100æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
    }

    // å…¥è·å˜ä¾¡ã®ç¯„å›²ãƒã‚§ãƒƒã‚¯
    if (data.purchasePrice != null && (data.purchasePrice < 0 || data.purchasePrice > 99999999)) {
      errors.push('å…¥è·å˜ä¾¡ã¯0ã€œ99,999,999å††ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
    }

    return errors;
  },

  async submit() {
    const data = this.collectFormData();
    const errors = this.validateFormData(data);

    if (errors.length > 0) {
      Toast.warning(errors[0]);
      return;
    }

    try {
      Loading.show();
      let productId;

      if (this.isEditMode) {
        // æ›´æ–°
        await Api.updateProduct(this.editProductId, data);
        productId = this.editProductId;

        // æ–°ã—ãè¿½åŠ ã•ã‚ŒãŸåŠ å·¥è²»ã‚’ä¿å­˜ï¼ˆexistingIdãŒãªã„ã‚‚ã®ã®ã¿ï¼‰
        const newCosts = this.processingCosts.filter(c => !c.existingId);
        for (const cost of newCosts) {
          if (cost.processingType && cost.processorId && cost.amount > 0) {
            await Api.createProcessingCost({
              productId: productId,
              processingType: cost.processingType,
              processorId: cost.processorId,
              processingContent: cost.processingContent || null,
              amount: cost.amount,
            });
          }
        }

        Toast.success('è£½å“ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
      } else {
        // æ–°è¦ç™»éŒ²
        const result = await Api.createProduct(data);
        productId = result.productId;

        // åŠ å·¥è²»ã‚’ä¿å­˜
        for (const cost of this.processingCosts) {
          if (cost.processingType && cost.processorId && cost.amount > 0) {
            await Api.createProcessingCost({
              productId: productId,
              processingType: cost.processingType,
              processorId: cost.processorId,
              processingContent: cost.processingContent || null,
              amount: cost.amount,
            });
          }
        }

        Toast.success(`è£½å“ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼ˆID: ${productId}ï¼‰`);
      }

      App.navigateTo('product-detail', { productId: productId });
    } catch (error) {
      console.error('Failed to save product:', error);
      Toast.error(this.isEditMode ? 'è£½å“ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ' : 'è£½å“ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      Loading.hide();
    }
  },
};

/**
 * è£½å“è©³ç´°
 */
const ProductDetail = {
  productId: null,
  product: null,
  processingCosts: [],

  async init(productId) {
    this.productId = productId || 'ITA-0001';
    await this.loadProduct();
    await this.loadProcessingCosts();
  },

  async loadProduct() {
    try {
      const product = await Api.getProduct(this.productId);
      if (product) {
        this.product = product;
        this.render();
      } else {
        Toast.error('è£½å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        App.navigateTo('products');
      }
    } catch (error) {
      console.error('Failed to load product:', error);
      Toast.error('è£½å“ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
      this.product = {
        productId: this.productId,
        productName: 'èª­ã¿è¾¼ã¿å¤±æ•—',
        status: 'ä¸æ˜',
      };
      this.render();
    }
  },

  async loadProcessingCosts() {
    try {
      const result = await Api.getProcessingCosts(this.productId);
      this.processingCosts = result?.costs || [];
      this.renderProcessingCosts();
    } catch (error) {
      console.error('Failed to load processing costs:', error);
      this.processingCosts = [];
      this.renderProcessingCosts();
    }
  },

  render() {
    const p = this.product;

    document.getElementById('detailProductName').textContent = p.productName || '-';
    document.getElementById('detailProductId').textContent = p.productId || '-';

    const statusEl = document.getElementById('detailStatus');
    statusEl.textContent = p.status || '-';
    statusEl.className = `badge ${Utils.getStatusClass(p.status)}`;

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³
    var statusSelect = document.getElementById('statusChangeSelect');
    var statusBtn = document.getElementById('statusChangeBtn');
    if (statusSelect && statusBtn) {
      if (p.status === 'å‰Šé™¤æ¸ˆã¿') {
        statusSelect.style.display = 'none';
        statusBtn.style.display = 'none';
      } else {
        statusSelect.style.display = '';
        statusBtn.style.display = '';
        statusSelect.value = p.status;
      }
    }

    // å†™çœŸã‚®ãƒ£ãƒ©ãƒªãƒ¼è¡¨ç¤º
    this.renderPhotoGallery();

    document.getElementById('detailMajorCategory').textContent = p.majorCategory || '-';
    document.getElementById('detailWoodType').textContent = p.woodType || '-';
    document.getElementById('detailStorageLocation').textContent = App.getStorageLocationName(p.storageLocationId || p.storageLocation);

    document.getElementById('detailRawLength').textContent = Utils.formatSize(p.rawLength);
    document.getElementById('detailRawWidth').textContent = Utils.formatSize(p.rawWidth);
    document.getElementById('detailRawThickness').textContent = Utils.formatSize(p.rawThickness);
    document.getElementById('detailFinishedLength').textContent = Utils.formatSize(p.finishedLength);
    document.getElementById('detailFinishedWidth').textContent = Utils.formatSize(p.finishedWidth);
    document.getElementById('detailFinishedThickness').textContent = Utils.formatSize(p.finishedThickness);

    document.getElementById('detailSupplier').textContent = App.getSupplierName(p.supplierId);
    document.getElementById('detailPurchaseDate').textContent = Utils.formatDate(p.purchaseDate);
    document.getElementById('detailPurchasePrice').textContent = Utils.formatCurrency(p.purchasePrice);
    document.getElementById('detailStockDays').textContent = p.stockDays ? `${p.stockDays}æ—¥` : '-';

    const calc = p.calculated || {};
    document.getElementById('detailProcessingCost').textContent = Utils.formatCurrency(calc.processingCostTotal || 0);
    document.getElementById('detailShippingCost').textContent = Utils.formatCurrency(p.shippingCost || 0);
    document.getElementById('detailTotalCost').textContent = Utils.formatCurrency(calc.totalCost || 0);
    document.getElementById('detailProfitMargin').textContent = p.profitMargin ? `${p.profitMargin}%` : '60%';
    document.getElementById('detailSuggestedPrice').textContent = Utils.formatCurrency(calc.suggestedPrice || 0);
    document.getElementById('detailPriceAdjustment').textContent = Utils.formatCurrency(p.priceAdjustment || 0);
    document.getElementById('detailPriceExTax').textContent = Utils.formatCurrency(calc.sellingPriceExTax || 0);
    document.getElementById('detailPriceIncTax').textContent = Utils.formatCurrency(calc.sellingPriceIncTax || 0);

    // é…é€æƒ…å ±
    document.getElementById('detailShippingCarrier').textContent = p.shippingCarrier || '-';
    document.getElementById('detailDeliveryDate').textContent = Utils.formatDate(p.deliveryDate);

    // å•†è«‡æƒ…å ±
    const negotiationSection = document.getElementById('detailNegotiationSection');
    if (negotiationSection) {
      if (p.status === 'å•†è«‡ä¸­' && (p.negotiator || p.department)) {
        negotiationSection.classList.remove('hidden');
        document.getElementById('detailNegotiator').textContent = p.negotiator || '-';
        document.getElementById('detailDepartment').textContent = p.department || '-';
      } else {
        negotiationSection.classList.add('hidden');
      }
    }

    // å‚™è€ƒ
    const remarksEl = document.getElementById('detailRemarks');
    if (remarksEl) {
      remarksEl.textContent = p.remarks || '-';
    }

    // è²©å£²ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
    const btnSell = document.getElementById('btnSell');
    if (btnSell) {
      if (p.status === 'è²©å£²æ¸ˆã¿' || p.status === 'å‰Šé™¤æ¸ˆã¿') {
        btnSell.disabled = true;
        btnSell.style.display = 'none';
      } else {
        btnSell.disabled = false;
        btnSell.style.display = '';
      }
    }

    // å•†è«‡é–‹å§‹ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
    const btnNegotiate = document.getElementById('btnNegotiate');
    if (btnNegotiate) {
      if (p.status === 'è²©å£²ä¸­') {
        btnNegotiate.style.display = '';
      } else {
        btnNegotiate.style.display = 'none';
      }
    }
  },

  // URLã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦JSONé…åˆ— or å˜ä¸€URLã‚’é…åˆ—ã«å¤‰æ›
  parsePhotoUrls(urlStr) {
    if (!urlStr) return [];
    try {
      if (urlStr.startsWith('[')) return JSON.parse(urlStr);
    } catch(e) {}
    return [urlStr];
  },

  // ã‚«ãƒ«ãƒ¼ã‚»ãƒ«çŠ¶æ…‹
  carouselTab: 'raw',
  carouselIndex: 0,

  // å†™çœŸã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‚’è¡¨ç¤ºï¼ˆã‚«ãƒ«ãƒ¼ã‚»ãƒ«å¯¾å¿œï¼‰
  renderPhotoGallery() {
    var gallery = document.getElementById('detailGallery');
    if (!gallery) return;

    var p = this.product;
    var rawPhotos = this.parsePhotoUrls(p.rawPhotoUrls);
    var finishedPhotos = this.parsePhotoUrls(p.finishedPhotoUrls);

    if (rawPhotos.length === 0 && finishedPhotos.length === 0) {
      gallery.textContent = '';
      var placeholder = document.createElement('div');
      placeholder.className = 'product-card-placeholder no-photo-clickable';
      placeholder.style.height = '200px';
      placeholder.title = 'ã‚¯ãƒªãƒƒã‚¯ã—ã¦å†™çœŸã‚’è¿½åŠ ';
      placeholder.textContent = 'ğŸ“· å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“';
      gallery.appendChild(placeholder);
      this.setupNoPhotoUpload(placeholder);
      return;
    }

    this.carouselTab = rawPhotos.length > 0 ? 'raw' : 'finished';
    this.carouselIndex = 0;
    this._rawPhotos = rawPhotos;
    this._finishedPhotos = finishedPhotos;
    this._buildCarousel(gallery);
  },

  _buildCarousel(gallery) {
    var self = this;
    var rawPhotos = this._rawPhotos;
    var finishedPhotos = this._finishedPhotos;
    var photos = this.carouselTab === 'raw' ? rawPhotos : finishedPhotos;
    if (this.carouselIndex >= photos.length) this.carouselIndex = 0;

    gallery.textContent = '';

    // ã‚¿ãƒ–åˆ‡æ›¿ï¼ˆä¸¡æ–¹ã‚ã‚‹å ´åˆã®ã¿ï¼‰
    if (rawPhotos.length > 0 && finishedPhotos.length > 0) {
      var tabBar = document.createElement('div');
      tabBar.style.cssText = 'display:flex;gap:8px;margin-bottom:12px;';
      var rawTab = document.createElement('button');
      rawTab.className = 'btn btn-sm ' + (this.carouselTab === 'raw' ? 'btn-primary' : 'btn-secondary');
      rawTab.textContent = 'å…¥è·æ™‚ï¼ˆ' + rawPhotos.length + 'æšï¼‰';
      rawTab.onclick = function() { self.carouselTab = 'raw'; self.carouselIndex = 0; self._buildCarousel(gallery); };
      var finTab = document.createElement('button');
      finTab.className = 'btn btn-sm ' + (this.carouselTab === 'finished' ? 'btn-primary' : 'btn-secondary');
      finTab.textContent = 'ä»•ä¸Šã’å¾Œï¼ˆ' + finishedPhotos.length + 'æšï¼‰';
      finTab.onclick = function() { self.carouselTab = 'finished'; self.carouselIndex = 0; self._buildCarousel(gallery); };
      tabBar.appendChild(rawTab);
      tabBar.appendChild(finTab);
      gallery.appendChild(tabBar);
    }

    if (photos.length === 0) return;

    // ãƒ¡ã‚¤ãƒ³ç”»åƒ + å·¦å³çŸ¢å°
    var mainWrap = document.createElement('div');
    mainWrap.style.cssText = 'position:relative;text-align:center;';

    var mainImg = document.createElement('img');
    mainImg.src = this.convertDriveUrl(photos[this.carouselIndex]);
    mainImg.alt = 'è£½å“å†™çœŸ';
    mainImg.className = 'product-photo-main';
    mainImg.id = 'mainPhoto';
    mainImg.onerror = function() { this.style.display = 'none'; };
    mainWrap.appendChild(mainImg);

    if (photos.length > 1) {
      var prevBtn = document.createElement('button');
      prevBtn.textContent = 'â€¹';
      prevBtn.className = 'btn btn-secondary';
      prevBtn.style.cssText = 'position:absolute;left:4px;top:50%;transform:translateY(-50%);padding:4px 10px;font-size:20px;opacity:0.8;';
      prevBtn.onclick = function() { self.carouselIndex = (self.carouselIndex - 1 + photos.length) % photos.length; self._buildCarousel(gallery); };
      mainWrap.appendChild(prevBtn);

      var nextBtn = document.createElement('button');
      nextBtn.textContent = 'â€º';
      nextBtn.className = 'btn btn-secondary';
      nextBtn.style.cssText = 'position:absolute;right:4px;top:50%;transform:translateY(-50%);padding:4px 10px;font-size:20px;opacity:0.8;';
      nextBtn.onclick = function() { self.carouselIndex = (self.carouselIndex + 1) % photos.length; self._buildCarousel(gallery); };
      mainWrap.appendChild(nextBtn);
    }

    gallery.appendChild(mainWrap);

    // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
    var counter = document.createElement('p');
    counter.className = 'text-muted text-sm';
    counter.style.textAlign = 'center';
    counter.textContent = (this.carouselIndex + 1) + ' / ' + photos.length + 'æš' + (rawPhotos.length > 0 && finishedPhotos.length === 0 ? 'ï¼ˆå…¥è·æ™‚ï¼‰' : finishedPhotos.length > 0 && rawPhotos.length === 0 ? 'ï¼ˆä»•ä¸Šã’å¾Œï¼‰' : '');
    gallery.appendChild(counter);

    // ã‚µãƒ ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒªãƒƒãƒ—ï¼ˆ2æšä»¥ä¸Šã®å ´åˆï¼‰
    if (photos.length > 1) {
      var strip = document.createElement('div');
      strip.style.cssText = 'display:flex;gap:6px;justify-content:center;margin-top:8px;flex-wrap:wrap;';
      photos.forEach(function(url, idx) {
        var thumb = document.createElement('img');
        thumb.src = self.convertDriveUrl(url);
        thumb.alt = 'å†™çœŸ' + (idx + 1);
        thumb.className = 'product-photo-thumb' + (idx === self.carouselIndex ? ' active' : '');
        thumb.style.cssText = 'width:60px;height:60px;object-fit:cover;border-radius:4px;cursor:pointer;border:2px solid ' + (idx === self.carouselIndex ? 'var(--color-primary)' : 'transparent') + ';';
        thumb.onclick = function() { self.carouselIndex = idx; self._buildCarousel(gallery); };
        thumb.onerror = function() { this.style.display = 'none'; };
        strip.appendChild(thumb);
      });
      gallery.appendChild(strip);
    }
  },

  // Google Drive URLã‚’å¤‰æ›
  convertDriveUrl(url) {
    if (!url) return null;
    var match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
    if (match) {
      return 'https://drive.google.com/thumbnail?id=' + match[1] + '&sz=w800';
    }
    match = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
    if (match) {
      return 'https://drive.google.com/thumbnail?id=' + match[1] + '&sz=w800';
    }
    return url;
  },

  // å†™çœŸãªã—çŠ¶æ…‹ã®ã‚¯ãƒªãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰è¨­å®š
  setupNoPhotoUpload(el) {
    if (!el) return;
    var self = this;
    el.style.cursor = 'pointer';
    el.addEventListener('click', function() {
      var fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = 'image/jpeg,image/png,image/webp';
      fileInput.addEventListener('change', function(e) {
        var file = e.target.files[0];
        if (!file) return;
        // ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãƒã‚§ãƒƒã‚¯
        var allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
        if (allowedTypes.indexOf(file.type) === -1) {
          Toast.error('å¯¾å¿œã—ã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚JPEGã€PNGã€WebPã®ã¿å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚');
          return;
        }
        // ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ (5MB)
        if (file.size > 5 * 1024 * 1024) {
          Toast.error('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ã€‚5MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ã€‚');
          return;
        }
        var reader = new FileReader();
        reader.onload = function(ev) {
          var base64 = ev.target.result.split(',')[1];
          Loading.show();
          var pname = (self.product && self.product.productName) ? self.product.productName : '';
          var existingPhotos = (self.product && self.product.rawPhotoUrls) ? self.product.rawPhotoUrls.split(',').filter(function(u) { return u.trim(); }).length : 0;
          Api.call('uploadProductPhoto', base64, file.name, file.type, self.productId, pname, 'raw', existingPhotos + 1)
            .then(function(result) {
              if (result && result.url) {
                return Api.updateProduct(self.productId, { rawPhotoUrls: result.url });
              } else {
                throw new Error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰çµæœãŒä¸æ­£ã§ã™');
              }
            })
            .then(function() {
              Toast.success('å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
              return self.loadProduct();
            })
            .catch(function(err) {
              console.error('Photo upload error:', err);
              Toast.error('å†™çœŸã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || err));
            })
            .finally(function() {
              Loading.hide();
            });
        };
        reader.readAsDataURL(file);
      });
      fileInput.click();
    });
  },

  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´
  async changeStatus() {
    var select = document.getElementById('statusChangeSelect');
    if (!select) return;
    var newStatus = select.value;
    var currentStatus = this.product.status;

    if (newStatus === currentStatus) {
      Toast.info('åŒã˜ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§ã™');
      return;
    }

    // è²©å£²æ¸ˆã¿ã‹ã‚‰ã®å¤‰æ›´æ™‚ã¯è­¦å‘Š
    if (currentStatus === 'è²©å£²æ¸ˆã¿') {
      if (!confirm('è²©å£²æ¸ˆã¿ã‹ã‚‰ã€Œ' + newStatus + 'ã€ã«å¤‰æ›´ã™ã‚‹ã¨ã€è²©å£²ãƒ‡ãƒ¼ã‚¿ï¼ˆè²©å£²å…ˆã€è²©å£²æ—¥ã€å®Ÿå£²ä¾¡æ ¼ã€è²©å£²å‚™è€ƒï¼‰ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
        select.value = currentStatus;
        return;
      }
    } else {
      if (!confirm('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œ' + newStatus + 'ã€ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ')) {
        select.value = currentStatus;
        return;
      }
    }

    try {
      Loading.show();
      await Api.call('updateProductStatus', this.productId, newStatus);
      Toast.success('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œ' + newStatus + 'ã€ã«å¤‰æ›´ã—ã¾ã—ãŸ');
      await this.loadProduct();
    } catch (error) {
      console.error('Failed to change status:', error);
      Toast.error('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || ''));
      select.value = currentStatus;
    } finally {
      Loading.hide();
    }
  },

  async exportPdf() {
    if (!this.product) return;
    try {
      Loading.show();
      var result = await Api.generateProductPdf(this.product.productId);
      if (result && result.success && result.url) {
        window.open(result.url, '_blank');
        Toast.success('PDFã‚’ç”Ÿæˆã—ã¾ã—ãŸ');
      } else {
        Toast.error('PDFç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    } catch (error) {
      console.error('Export PDF error:', error);
      Toast.error('PDFç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || ''));
    } finally {
      Loading.hide();
    }
  },

  renderProcessingCosts() {
    const container = document.getElementById('detailProcessingCostsTable');
    if (!container) return;

    if (this.processingCosts.length === 0) {
      container.innerHTML = '<p class="text-muted p-md">åŠ å·¥è²»ã®ç™»éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
      return;
    }

    const tableHtml = `
      <table class="table">
        <thead>
          <tr>
            <th>åŠ å·¥ç¨®åˆ¥</th>
            <th>åŠ å·¥æ¥­è€…</th>
            <th>åŠ å·¥å†…å®¹</th>
            <th style="text-align: right;">é‡‘é¡</th>
            <th style="width: 80px;"></th>
          </tr>
        </thead>
        <tbody>
          ${this.processingCosts.map(cost => `
            <tr>
              <td>${Utils.escapeHtml(cost.processingType || '-')}</td>
              <td>${Utils.escapeHtml(App.getProcessorName(cost.processorId))}</td>
              <td>${Utils.escapeHtml(cost.processingContent || '-')}</td>
              <td style="text-align: right;">${Utils.formatCurrency(cost.amount || 0)}</td>
              <td>
                <button class="btn btn-sm btn-danger" onclick="ProductDetail.deleteProcessingCost('${cost.processingCostId}')">å‰Šé™¤</button>
              </td>
            </tr>
          `).join('')}
        </tbody>
        <tfoot>
          <tr>
            <td colspan="3" style="text-align: right; font-weight: 600;">åˆè¨ˆ</td>
            <td style="text-align: right; font-weight: 700; color: var(--color-primary);">
              ${Utils.formatCurrency(this.processingCosts.reduce((sum, c) => sum + (c.amount || 0), 0))}
            </td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    `;

    container.innerHTML = tableHtml;
  },

  edit() {
    if (!this.product) {
      Toast.error('è£½å“æƒ…å ±ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
      return;
    }

    if (this.product.status === 'è²©å£²æ¸ˆã¿') {
      Toast.warning('è²©å£²æ¸ˆã¿ã®è£½å“ã¯ç·¨é›†ã§ãã¾ã›ã‚“');
      return;
    }

    if (this.product.status === 'å‰Šé™¤æ¸ˆã¿') {
      Toast.warning('å‰Šé™¤æ¸ˆã¿ã®è£½å“ã¯ç·¨é›†ã§ãã¾ã›ã‚“');
      return;
    }

    // è£½å“ç·¨é›†ãƒšãƒ¼ã‚¸ã¸é·ç§»ï¼ˆè£½å“ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã‚’ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ä½¿ç”¨ï¼‰
    App.navigateTo('product-edit', { productId: this.productId });
  },

  // ==================== è²©å£²å‡¦ç† ====================

  sell() {
    if (!this.product) {
      Toast.error('è£½å“æƒ…å ±ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
      return;
    }

    if (this.product.status === 'è²©å£²æ¸ˆã¿') {
      Toast.warning('ã“ã®è£½å“ã¯æ—¢ã«è²©å£²æ¸ˆã¿ã§ã™');
      return;
    }

    if (this.product.status === 'å‰Šé™¤æ¸ˆã¿') {
      Toast.warning('å‰Šé™¤æ¸ˆã¿ã®è£½å“ã¯è²©å£²ã§ãã¾ã›ã‚“');
      return;
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«è£½å“æƒ…å ±ã‚’è¨­å®š
    document.getElementById('sellProductName').textContent = this.product.productName || '-';
    document.getElementById('sellProductId').textContent = this.product.productId || '-';
    document.getElementById('sellSuggestedPrice').textContent = Utils.formatCurrency(this.product.sellingPriceIncTax || 0);

    // å®Ÿå£²ä¾¡æ ¼ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
    document.getElementById('actualSalesPrice').value = this.product.sellingPriceIncTax || 0;

    // è²©å£²æ—¥ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä»Šæ—¥ã«è¨­å®š
    document.getElementById('salesDate').value = new Date().toISOString().split('T')[0];

    // è²©å£²å…ˆã‚’ã‚¯ãƒªã‚¢
    document.getElementById('salesDestination').value = '';

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    document.getElementById('sellModal').classList.remove('hidden');
  },

  closeSellModal() {
    document.getElementById('sellModal').classList.add('hidden');
  },

  async submitSale() {
    const actualSalesPrice = parseFloat(document.getElementById('actualSalesPrice').value);
    const salesDate = document.getElementById('salesDate').value;
    const salesDestination = document.getElementById('salesDestination').value.trim();

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (isNaN(actualSalesPrice) || actualSalesPrice < 0) {
      Toast.warning('å®Ÿå£²ä¾¡æ ¼ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    if (!salesDate) {
      Toast.warning('è²©å£²æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    try {
      const deliveryDateValue = document.getElementById('sellDeliveryDate').value;
      const salesData = {
        soldPrice: actualSalesPrice,
        soldDate: salesDate,
        soldTo: salesDestination || null,
        deliveryDate: deliveryDateValue || undefined,
      };

      await Api.sellProduct(this.productId, salesData);

      Toast.success('è²©å£²å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ');
      this.closeSellModal();

      // è£½å“æƒ…å ±ã‚’å†èª­ã¿è¾¼ã¿
      await this.loadProduct();
    } catch (error) {
      console.error('Failed to sell product:', error);
      Toast.error('è²©å£²å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
    }
  },

  // ==================== åŠ å·¥è²»è¿½åŠ  ====================

  addProcessingCost() {
    if (!this.product) {
      Toast.error('è£½å“æƒ…å ±ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
      return;
    }

    if (this.product.status === 'è²©å£²æ¸ˆã¿' || this.product.status === 'å‰Šé™¤æ¸ˆã¿') {
      Toast.warning('ã“ã®è£½å“ã«ã¯åŠ å·¥è²»ã‚’è¿½åŠ ã§ãã¾ã›ã‚“');
      return;
    }

    // åŠ å·¥æ¥­è€…ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’åˆæœŸåŒ–
    App.populateSelect('processorId', App.masterData.processors, 'processorId', 'name');

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('processingCostForm').reset();

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    document.getElementById('processingCostModal').classList.remove('hidden');
  },

  closeProcessingCostModal() {
    document.getElementById('processingCostModal').classList.add('hidden');
  },

  async submitProcessingCost() {
    const processingType = document.getElementById('processingType').value;
    const processorId = document.getElementById('processorId').value;
    const processingContent = document.getElementById('processingContent').value.trim();
    const amount = parseFloat(document.getElementById('processingAmount').value);

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!processingType) {
      Toast.warning('åŠ å·¥ç¨®åˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }

    if (!processorId) {
      Toast.warning('åŠ å·¥æ¥­è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }

    if (isNaN(amount) || amount < 0) {
      Toast.warning('é‡‘é¡ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    try {
      const data = {
        productId: this.productId,
        processingType: processingType,
        processorId: processorId,
        processingContent: processingContent || null,
        amount: amount,
      };

      await Api.createProcessingCost(data);

      Toast.success('åŠ å·¥è²»ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
      this.closeProcessingCostModal();

      // åŠ å·¥è²»ä¸€è¦§ã¨è£½å“æƒ…å ±ã‚’å†èª­ã¿è¾¼ã¿
      await Promise.all([
        this.loadProcessingCosts(),
        this.loadProduct(),
      ]);
    } catch (error) {
      console.error('Failed to create processing cost:', error);
      Toast.error('åŠ å·¥è²»ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
    }
  },

  async deleteProcessingCost(costId) {
    if (!confirm('ã“ã®åŠ å·¥è²»ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
      return;
    }

    try {
      await Api.deleteProcessingCost(costId);

      Toast.success('åŠ å·¥è²»ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');

      // åŠ å·¥è²»ä¸€è¦§ã¨è£½å“æƒ…å ±ã‚’å†èª­ã¿è¾¼ã¿
      await Promise.all([
        this.loadProcessingCosts(),
        this.loadProduct(),
      ]);
    } catch (error) {
      console.error('Failed to delete processing cost:', error);
      Toast.error('åŠ å·¥è²»ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
    }
  },

  // ==================== å•†è«‡é–‹å§‹ ====================

  negotiate() {
    if (!this.product) {
      Toast.error('è£½å“æƒ…å ±ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
      return;
    }

    if (this.product.status !== 'è²©å£²ä¸­') {
      Toast.warning('è²©å£²ä¸­ã®è£½å“ã®ã¿å•†è«‡é–‹å§‹ã§ãã¾ã™');
      return;
    }

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('negotiatorName').value = '';
    document.getElementById('negotiatorDepartment').value = '';

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    document.getElementById('negotiateModal').classList.remove('hidden');
  },

  closeNegotiateModal() {
    document.getElementById('negotiateModal').classList.add('hidden');
  },

  async submitNegotiate() {
    const negotiatorName = document.getElementById('negotiatorName').value.trim();
    const negotiatorDepartment = document.getElementById('negotiatorDepartment').value.trim();

    if (!negotiatorName) {
      Toast.warning('æ‹…å½“è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    try {
      Loading.show();
      await Api.updateProduct(this.productId, {
        status: 'å•†è«‡ä¸­',
        negotiator: negotiatorName,
        department: negotiatorDepartment || undefined,
      });

      Toast.success('å•†è«‡ã‚’é–‹å§‹ã—ã¾ã—ãŸ');
      this.closeNegotiateModal();

      // è£½å“æƒ…å ±ã‚’å†èª­ã¿è¾¼ã¿
      await this.loadProduct();
    } catch (error) {
      console.error('Failed to start negotiation:', error);
      Toast.error('å•†è«‡é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
    } finally {
      Loading.hide();
    }
  },
};

/**
 * æ£šå¸ã—
 */
const Inventory = {
  currentSession: null,
  products: {
    unconfirmed: [],
    confirmed: [],
    discrepancy: [],
  },

  async init() {
    App.populateSelect('inventoryLocation', App.masterData.storageLocations, 'storageLocationId', 'name');
    await this.loadActiveSessions();
    this.showStartScreen();
  },

  showStartScreen() {
    document.getElementById('inventoryStart').classList.remove('hidden');
    document.getElementById('inventorySession').classList.add('hidden');
  },

  showSessionScreen() {
    document.getElementById('inventoryStart').classList.add('hidden');
    document.getElementById('inventorySession').classList.remove('hidden');
  },

  async loadActiveSessions() {
    try {
      const sessions = await Api.call('getActiveSessions');
      this.renderActiveSessions(sessions || []);
    } catch (error) {
      console.error('Failed to load active sessions:', error);
      this.renderActiveSessions([]);
    }
  },

  renderActiveSessions(sessions) {
    const container = document.getElementById('ongoingSessionsList');

    if (!sessions || sessions.length === 0) {
      container.innerHTML = '<p class="text-muted">é€²è¡Œä¸­ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
      return;
    }

    container.innerHTML = sessions.map(session => {
      const location = App.masterData.storageLocations.find(l => l.storageLocationId === session.storageLocationId);
      const locationName = location ? location.name : session.storageLocationId;
      const progress = session.targetCount > 0 ? Math.round((session.confirmedCount / session.targetCount) * 100) : 0;

      return `
        <div class="card mb-sm" style="cursor: pointer;" onclick="Inventory.resumeSession('${session.sessionId}')">
          <div class="card-body">
            <div class="flex items-center justify-between">
              <div>
                <strong>${Utils.escapeHtml(locationName)}</strong>
                <p class="text-muted text-sm">${Utils.formatDate(session.startedAt)} é–‹å§‹</p>
              </div>
              <div style="text-align: right;">
                <span class="badge badge-warning">é€²è¡Œä¸­</span>
                <p class="text-sm mt-xs">${session.confirmedCount}/${session.targetCount} (${progress}%)</p>
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('');
  },

  async startSession() {
    const locationId = document.getElementById('inventoryLocation').value;
    if (!locationId) {
      Toast.warning('ä¿ç®¡å ´æ‰€ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }

    try {
      const session = await Api.callWithLoading('startInventorySession', locationId);

      if (!session) {
        Toast.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
        return;
      }

      this.currentSession = session;
      Toast.success('æ£šå¸ã—ã‚’é–‹å§‹ã—ã¾ã—ãŸ');
      await this.loadSessionProgress();
      this.showSessionScreen();
    } catch (error) {
      console.error('Failed to start session:', error);
      Toast.error('æ£šå¸ã—ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
    }
  },

  async resumeSession(sessionId) {
    try {
      const progress = await Api.callWithLoading('getInventoryProgress', sessionId);

      if (!progress) {
        Toast.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        return;
      }

      this.currentSession = progress;
      this.updateProgressUI(progress);
      this.products.unconfirmed = progress.unconfirmedProducts || [];
      this.products.confirmed = progress.confirmedProducts || [];
      this.products.discrepancy = progress.discrepancyProducts || [];
      this.renderProductLists();
      this.showSessionScreen();
    } catch (error) {
      console.error('Failed to resume session:', error);
      Toast.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å†é–‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  },

  async loadSessionProgress() {
    if (!this.currentSession?.sessionId) return;

    try {
      const progress = await Api.call('getInventoryProgress', this.currentSession.sessionId);

      if (progress) {
        this.currentSession = progress;
        this.updateProgressUI(progress);
        this.products.unconfirmed = progress.unconfirmedProducts || [];
        this.products.confirmed = progress.confirmedProducts || [];
        this.products.discrepancy = progress.discrepancyProducts || [];
        this.renderProductLists();
      }
    } catch (error) {
      console.error('Failed to load session progress:', error);
    }
  },

  updateProgressUI(progress) {
    const location = App.masterData.storageLocations.find(l => l.storageLocationId === progress.storageLocationId);
    document.getElementById('sessionLocation').textContent = location ? location.name : progress.storageLocationId;

    const confirmed = progress.confirmedCount || 0;
    const target = progress.targetCount || 0;
    const discrepancy = progress.discrepancyCount || 0;
    const unconfirmed = target - confirmed;
    const percentage = target > 0 ? Math.round((confirmed / target) * 100) : 0;

    document.getElementById('confirmedCount').textContent = confirmed;
    document.getElementById('unconfirmedCount').textContent = unconfirmed;
    document.getElementById('discrepancyCount').textContent = discrepancy;
    document.getElementById('progressBar').style.width = `${percentage}%`;
  },

  renderProductLists() {
    this.renderUnconfirmedList();
    this.renderConfirmedList();
    this.renderDiscrepancyList();
  },

  renderUnconfirmedList() {
    const container = document.getElementById('unconfirmedList');
    const products = this.products.unconfirmed || [];

    if (products.length === 0) {
      container.innerHTML = '<p class="text-muted text-center p-lg">æœªç¢ºèªã®è£½å“ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
      return;
    }

    container.innerHTML = products.map(p => `
      <div class="card mb-sm">
        <div class="card-body flex items-center justify-between">
          <div>
            <strong>${Utils.escapeHtml(p.productName || p.productId)}</strong>
            <p class="text-muted text-sm">${Utils.escapeHtml(p.productId)}</p>
          </div>
          <button class="btn btn-sm btn-primary" onclick="Inventory.confirmProduct('${p.productId}', 'list')">
            ç¢ºèª
          </button>
        </div>
      </div>
    `).join('');
  },

  renderConfirmedList() {
    const container = document.getElementById('confirmedList');
    const products = this.products.confirmed || [];

    if (products.length === 0) {
      container.innerHTML = '<p class="text-muted text-center p-lg">ç¢ºèªæ¸ˆã¿ã®è£½å“ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
      return;
    }

    container.innerHTML = products.map(p => `
      <div class="card mb-sm">
        <div class="card-body flex items-center justify-between">
          <div>
            <strong>${Utils.escapeHtml(p.productName || p.productId)}</strong>
            <p class="text-muted text-sm">${Utils.escapeHtml(p.productId)}</p>
          </div>
          <span class="badge badge-success">ç¢ºèªæ¸ˆã¿</span>
        </div>
      </div>
    `).join('');
  },

  renderDiscrepancyList() {
    const container = document.getElementById('discrepancyList');
    const products = this.products.discrepancy || [];

    if (products.length === 0) {
      container.innerHTML = '<p class="text-muted text-center p-lg">å·®ç•°ã®ã‚ã‚‹è£½å“ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
      return;
    }

    container.innerHTML = products.map(p => `
      <div class="card mb-sm" style="border-color: var(--color-error);">
        <div class="card-body">
          <div class="flex items-center justify-between">
            <div>
              <strong>${Utils.escapeHtml(p.productName || p.productId)}</strong>
              <p class="text-muted text-sm">${Utils.escapeHtml(p.productId)}</p>
            </div>
            <span class="badge badge-error">å·®ç•°ã‚ã‚Š</span>
          </div>
          <p class="text-error text-sm mt-sm">${Utils.escapeHtml(p.discrepancyReason || 'è¦ç¢ºèª')}</p>
        </div>
      </div>
    `).join('');
  },

  switchTab(tab) {
    document.querySelectorAll('#inventorySession .tab').forEach((t) => t.classList.remove('active'));
    document.querySelectorAll('#inventorySession .tab-content').forEach((c) => c.classList.remove('active'));

    event.target.classList.add('active');
    const tabId = `tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`;
    document.getElementById(tabId).classList.add('active');
  },

  openScanner() {
    // GASã§ã¯ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ãŒåˆ¶é™ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€QRã‚¹ã‚­ãƒ£ãƒ³ã¯ä»£æ›¿å®Ÿè£…
    // ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹ã§ã¯åˆ¥ã®QRãƒªãƒ¼ãƒ€ãƒ¼ã‚¢ãƒ—ãƒªã‚’ä½¿ç”¨ã—ã€è£½å“IDã‚’æ‰‹å…¥åŠ›ã™ã‚‹é‹ç”¨ã‚’æ¨å¥¨
    Toast.info('QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦IDã‚’å–å¾—ã—ã€æ‰‹å…¥åŠ›æ¬„ã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
    document.getElementById('manualProductId').focus();
  },

  async confirmManual() {
    const productId = document.getElementById('manualProductId').value.trim().toUpperCase();
    if (!productId) {
      Toast.warning('è£½å“IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    await this.confirmProduct(productId, 'manual');
    document.getElementById('manualProductId').value = '';
  },

  async confirmProduct(productId, method) {
    if (!this.currentSession?.sessionId) {
      Toast.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒé–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“');
      return;
    }

    try {
      await Api.call('confirmInventoryProduct', this.currentSession.sessionId, productId, method);
      Toast.success(`${productId} ã‚’ç¢ºèªã—ã¾ã—ãŸ`);
      await this.loadSessionProgress();
    } catch (error) {
      console.error('Failed to confirm product:', error);
      Toast.error('ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
    }
  },

  async pauseSession() {
    if (!this.currentSession?.sessionId) {
      Toast.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒé–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“');
      return;
    }

    if (!confirm('æ£šå¸ã—ã‚’ä¸­æ–­ã—ã¾ã™ã‹ï¼Ÿå¾Œã‹ã‚‰å†é–‹ã§ãã¾ã™ã€‚')) {
      return;
    }

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯è‡ªå‹•çš„ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ç”»é¢ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã ã‘
    Toast.info('æ£šå¸ã—ã‚’ä¸­æ–­ã—ã¾ã—ãŸã€‚ã„ã¤ã§ã‚‚å†é–‹ã§ãã¾ã™ã€‚');
    this.currentSession = null;
    await this.loadActiveSessions();
    this.showStartScreen();
  },

  async completeSession() {
    if (!this.currentSession?.sessionId) {
      Toast.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒé–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“');
      return;
    }

    const unconfirmedCount = this.products.unconfirmed?.length || 0;

    if (unconfirmedCount > 0) {
      if (!confirm(`æœªç¢ºèªã®è£½å“ãŒ${unconfirmedCount}ä»¶ã‚ã‚Šã¾ã™ã€‚æ£šå¸ã—ã‚’å®Œäº†ã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
      }
    } else {
      if (!confirm('æ£šå¸ã—ã‚’å®Œäº†ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }
    }

    try {
      await Api.callWithLoading('completeInventorySession', this.currentSession.sessionId);
      Toast.success('æ£šå¸ã—ã‚’å®Œäº†ã—ã¾ã—ãŸ');
      this.currentSession = null;
      await this.loadActiveSessions();
      this.showStartScreen();
    } catch (error) {
      console.error('Failed to complete session:', error);
      Toast.error('å®Œäº†å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
    }
  },
};

/**
 * ãƒã‚¹ã‚¿ãƒ¼ç®¡ç†
 */
const Master = {
  currentTab: 'woodTypes',

  async init() {
    await this.loadAllMasters();
  },

  async loadAllMasters() {
    // ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
    await App.loadMasterData();
    this.renderWoodTypes();
    this.renderSuppliers();
    this.renderProcessors();
    this.renderStorageLocations();
    this.renderMajorCategories();
    this.renderRequiredFields();
  },

  switchTab(tab) {
    document.querySelectorAll('#page-masters .tab').forEach((t) => t.classList.remove('active'));
    document.querySelectorAll('#page-masters .tab-content').forEach((c) => {
      c.classList.add('hidden');
      c.classList.remove('active');
    });

    event.target.classList.add('active');
    const tabContent = document.getElementById(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
    tabContent.classList.remove('hidden');
    tabContent.classList.add('active');

    this.currentTab = tab;
  },

  // ==================== å¿…é ˆé …ç›®è¨­å®š ====================

  REQUIRED_FIELD_OPTIONS: [
    { key: 'majorCategory', label: 'å¤§åˆ†é¡' },
    { key: 'productName', label: 'å•†å“å' },
    { key: 'woodType', label: 'æ¨¹ç¨®' },
    { key: 'storageLocationId', label: 'ä¿ç®¡å ´æ‰€' },
    { key: 'supplierId', label: 'ä»•å…¥ã‚Œå…ˆ' },
    { key: 'purchaseDate', label: 'ä»•å…¥ã‚Œæ—¥' },
    { key: 'purchasePrice', label: 'å…¥è·å˜ä¾¡' },
    { key: 'rawLength', label: 'å…¥è·æ™‚ é•·ã•' },
    { key: 'rawWidth', label: 'å…¥è·æ™‚ å¹…' },
    { key: 'rawThickness', label: 'å…¥è·æ™‚ åšã¿' },
    { key: 'finishedLength', label: 'ä»•ä¸Šã’å¾Œ é•·ã•' },
    { key: 'finishedWidth', label: 'ä»•ä¸Šã’å¾Œ å¹…' },
    { key: 'finishedThickness', label: 'ä»•ä¸Šã’å¾Œ åšã¿' },
    { key: 'shippingCost', label: 'è²©å£²æ™‚é€æ–™' },
    { key: 'profitMargin', label: 'åˆ©ç›Šç‡' },
    { key: 'remarks', label: 'å‚™è€ƒ' },
  ],

  renderRequiredFields() {
    var container = document.getElementById('requiredFieldsList');
    if (!container) return;

    var currentRequired = App.masterData.requiredFields || [];
    // Safe DOM construction - all labels are from hardcoded REQUIRED_FIELD_OPTIONS
    container.textContent = '';
    for (var i = 0; i < this.REQUIRED_FIELD_OPTIONS.length; i++) {
      var opt = this.REQUIRED_FIELD_OPTIONS[i];
      var checked = currentRequired.indexOf(opt.key) >= 0;

      var div = document.createElement('div');
      div.className = 'required-field-item';

      var input = document.createElement('input');
      input.type = 'checkbox';
      input.className = 'required-field-toggle';
      input.id = 'reqField_' + opt.key;
      input.value = opt.key;
      input.checked = checked;

      var label = document.createElement('label');
      label.setAttribute('for', 'reqField_' + opt.key);
      label.textContent = opt.label;

      div.appendChild(input);
      div.appendChild(label);
      container.appendChild(div);
    }
  },

  async saveRequiredFields() {
    try {
      var checkboxes = document.querySelectorAll('#requiredFieldsList .required-field-toggle:checked');
      var fields = [];
      for (var i = 0; i < checkboxes.length; i++) {
        fields.push(checkboxes[i].value);
      }
      await Api.setRequiredFields(fields);
      App.masterData.requiredFields = fields;
      Toast.success('å¿…é ˆé …ç›®è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    } catch (error) {
      console.error('saveRequiredFields error:', error);
      Toast.error('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || ''));
    }
  },

  // ==================== æ¨¹ç¨®ãƒã‚¹ã‚¿ãƒ¼ ====================

  renderWoodTypes() {
    const tbody = document.getElementById('woodTypesBody');
    if (App.masterData.woodTypes.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" class="text-muted text-center">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
      return;
    }
    tbody.innerHTML = App.masterData.woodTypes
      .map(
        (item) => `
      <tr>
        <td>${Utils.escapeHtml(item.woodTypeId)}</td>
        <td>${Utils.escapeHtml(item.name)}</td>
        <td>${item.displayOrder || '-'}</td>
        <td>
          <button class="btn btn-sm btn-secondary" onclick="Master.editWoodType('${item.woodTypeId}')">ç·¨é›†</button>
        </td>
      </tr>
    `
      )
      .join('');
  },

  addWoodType() {
    document.getElementById('woodTypeModalTitle').textContent = 'æ¨¹ç¨®ã‚’è¿½åŠ ';
    document.getElementById('woodTypeEditId').value = '';
    document.getElementById('woodTypeName').value = '';
    document.getElementById('woodTypeDisplayOrder').value = '';
    document.getElementById('woodTypeModal').classList.remove('hidden');
  },

  editWoodType(id) {
    const item = App.masterData.woodTypes.find(w => w.woodTypeId === id);
    if (!item) {
      Toast.error('æ¨¹ç¨®ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }
    document.getElementById('woodTypeModalTitle').textContent = 'æ¨¹ç¨®ã‚’ç·¨é›†';
    document.getElementById('woodTypeEditId').value = id;
    document.getElementById('woodTypeName').value = item.name || '';
    document.getElementById('woodTypeDisplayOrder').value = item.displayOrder || '';
    document.getElementById('woodTypeModal').classList.remove('hidden');
  },

  closeWoodTypeModal() {
    document.getElementById('woodTypeModal').classList.add('hidden');
  },

  async submitWoodType() {
    const editId = document.getElementById('woodTypeEditId').value;
    const name = document.getElementById('woodTypeName').value.trim();
    const displayOrder = document.getElementById('woodTypeDisplayOrder').value;

    if (!name) {
      Toast.warning('æ¨¹ç¨®åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    try {
      const data = {
        name: name,
        displayOrder: displayOrder ? parseInt(displayOrder) : undefined,
      };

      await Api.addMasterData('woodType', data);
      Toast.success(editId ? 'æ¨¹ç¨®ã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'æ¨¹ç¨®ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
      this.closeWoodTypeModal();
      await this.loadAllMasters();
    } catch (error) {
      console.error('Failed to save wood type:', error);
      Toast.error('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  },

  // ==================== ä»•å…¥ã‚Œå…ˆãƒã‚¹ã‚¿ãƒ¼ ====================

  renderSuppliers() {
    const tbody = document.getElementById('suppliersBody');
    if (App.masterData.suppliers.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="text-muted text-center">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
      return;
    }
    tbody.innerHTML = App.masterData.suppliers
      .map(
        (item) => `
      <tr>
        <td>${Utils.escapeHtml(item.supplierId)}</td>
        <td>${Utils.escapeHtml(item.name)}</td>
        <td>${Utils.escapeHtml(item.contact || '-')}</td>
        <td>${Utils.escapeHtml(item.address || '-')}</td>
        <td>
          <button class="btn btn-sm btn-secondary" onclick="Master.editSupplier('${item.supplierId}')">ç·¨é›†</button>
        </td>
      </tr>
    `
      )
      .join('');
  },

  addSupplier() {
    document.getElementById('supplierModalTitle').textContent = 'ä»•å…¥ã‚Œå…ˆã‚’è¿½åŠ ';
    document.getElementById('supplierEditId').value = '';
    document.getElementById('supplierName').value = '';
    document.getElementById('supplierContact').value = '';
    document.getElementById('supplierAddress').value = '';
    document.getElementById('supplierModal').classList.remove('hidden');
  },

  editSupplier(id) {
    const item = App.masterData.suppliers.find(s => s.supplierId === id);
    if (!item) {
      Toast.error('ä»•å…¥ã‚Œå…ˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }
    document.getElementById('supplierModalTitle').textContent = 'ä»•å…¥ã‚Œå…ˆã‚’ç·¨é›†';
    document.getElementById('supplierEditId').value = id;
    document.getElementById('supplierName').value = item.name || '';
    document.getElementById('supplierContact').value = item.contact || '';
    document.getElementById('supplierAddress').value = item.address || '';
    document.getElementById('supplierModal').classList.remove('hidden');
  },

  closeSupplierModal() {
    document.getElementById('supplierModal').classList.add('hidden');
  },

  async submitSupplier() {
    const editId = document.getElementById('supplierEditId').value;
    const name = document.getElementById('supplierName').value.trim();
    const contact = document.getElementById('supplierContact').value.trim();
    const address = document.getElementById('supplierAddress').value.trim();

    if (!name) {
      Toast.warning('æ¥­è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    try {
      const data = {
        name: name,
        contact: contact || undefined,
        address: address || undefined,
      };

      await Api.addMasterData('supplier', data);
      Toast.success(editId ? 'ä»•å…¥ã‚Œå…ˆã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'ä»•å…¥ã‚Œå…ˆã‚’è¿½åŠ ã—ã¾ã—ãŸ');
      this.closeSupplierModal();
      await this.loadAllMasters();
    } catch (error) {
      console.error('Failed to save supplier:', error);
      Toast.error('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  },

  // ==================== åŠ å·¥æ¥­è€…ãƒã‚¹ã‚¿ãƒ¼ ====================

  renderProcessors() {
    const tbody = document.getElementById('processorsBody');
    if (App.masterData.processors.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="text-muted text-center">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
      return;
    }
    tbody.innerHTML = App.masterData.processors
      .map(
        (item) => `
      <tr>
        <td>${Utils.escapeHtml(item.processorId)}</td>
        <td>${Utils.escapeHtml(item.name)}</td>
        <td>${(item.processingTypes || []).join(', ') || '-'}</td>
        <td>${Utils.escapeHtml(item.contact || '-')}</td>
        <td>
          <button class="btn btn-sm btn-secondary" onclick="Master.editProcessor('${item.processorId}')">ç·¨é›†</button>
        </td>
      </tr>
    `
      )
      .join('');
  },

  addProcessor() {
    document.getElementById('processorModalTitle').textContent = 'åŠ å·¥æ¥­è€…ã‚’è¿½åŠ ';
    document.getElementById('processorEditId').value = '';
    document.getElementById('processorName').value = '';
    document.getElementById('processorContact').value = '';
    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
    document.querySelectorAll('#processorTypes input[type="checkbox"]').forEach(cb => cb.checked = false);
    document.getElementById('processorModal').classList.remove('hidden');
  },

  editProcessor(id) {
    const item = App.masterData.processors.find(p => p.processorId === id);
    if (!item) {
      Toast.error('åŠ å·¥æ¥­è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }
    document.getElementById('processorModalTitle').textContent = 'åŠ å·¥æ¥­è€…ã‚’ç·¨é›†';
    document.getElementById('processorEditId').value = id;
    document.getElementById('processorName').value = item.name || '';
    document.getElementById('processorContact').value = item.contact || '';
    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’è¨­å®š
    document.querySelectorAll('#processorTypes input[type="checkbox"]').forEach(cb => {
      cb.checked = (item.processingTypes || []).includes(cb.value);
    });
    document.getElementById('processorModal').classList.remove('hidden');
  },

  closeProcessorModal() {
    document.getElementById('processorModal').classList.add('hidden');
  },

  async submitProcessor() {
    const editId = document.getElementById('processorEditId').value;
    const name = document.getElementById('processorName').value.trim();
    const contact = document.getElementById('processorContact').value.trim();
    const processingTypes = Array.from(
      document.querySelectorAll('#processorTypes input[type="checkbox"]:checked')
    ).map(cb => cb.value);

    if (!name) {
      Toast.warning('æ¥­è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    try {
      const data = {
        name: name,
        contact: contact || undefined,
        processingTypes: processingTypes.length > 0 ? processingTypes : undefined,
      };

      await Api.addMasterData('processor', data);
      Toast.success(editId ? 'åŠ å·¥æ¥­è€…ã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'åŠ å·¥æ¥­è€…ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
      this.closeProcessorModal();
      await this.loadAllMasters();
    } catch (error) {
      console.error('Failed to save processor:', error);
      Toast.error('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  },

  // ==================== ä¿ç®¡å ´æ‰€ãƒã‚¹ã‚¿ãƒ¼ ====================

  renderStorageLocations() {
    const tbody = document.getElementById('storageLocationsBody');
    if (App.masterData.storageLocations.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="text-muted text-center">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
      return;
    }
    tbody.innerHTML = App.masterData.storageLocations
      .map(
        (item) => `
      <tr>
        <td>${Utils.escapeHtml(item.storageLocationId)}</td>
        <td>${Utils.escapeHtml(item.name)}</td>
        <td>${item.displayOrder || '-'}</td>
        <td>${Utils.formatDate(item.lastInventoryDate) || '-'}</td>
        <td>
          <button class="btn btn-sm btn-secondary" onclick="Master.editStorageLocation('${item.storageLocationId}')">ç·¨é›†</button>
        </td>
      </tr>
    `
      )
      .join('');
  },

  addStorageLocation() {
    document.getElementById('storageLocationModalTitle').textContent = 'ä¿ç®¡å ´æ‰€ã‚’è¿½åŠ ';
    document.getElementById('storageLocationEditId').value = '';
    document.getElementById('storageLocationName').value = '';
    document.getElementById('storageLocationDisplayOrder').value = '';
    document.getElementById('storageLocationModal').classList.remove('hidden');
  },

  editStorageLocation(id) {
    const item = App.masterData.storageLocations.find(l => l.storageLocationId === id);
    if (!item) {
      Toast.error('ä¿ç®¡å ´æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }
    document.getElementById('storageLocationModalTitle').textContent = 'ä¿ç®¡å ´æ‰€ã‚’ç·¨é›†';
    document.getElementById('storageLocationEditId').value = id;
    document.getElementById('storageLocationName').value = item.name || '';
    document.getElementById('storageLocationDisplayOrder').value = item.displayOrder || '';
    document.getElementById('storageLocationModal').classList.remove('hidden');
  },

  closeStorageLocationModal() {
    document.getElementById('storageLocationModal').classList.add('hidden');
  },

  async submitStorageLocation() {
    const editId = document.getElementById('storageLocationEditId').value;
    const name = document.getElementById('storageLocationName').value.trim();
    const displayOrder = document.getElementById('storageLocationDisplayOrder').value;

    if (!name) {
      Toast.warning('å ´æ‰€åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    try {
      const data = {
        name: name,
        displayOrder: displayOrder ? parseInt(displayOrder) : undefined,
      };

      await Api.addMasterData('storageLocation', data);
      Toast.success(editId ? 'ä¿ç®¡å ´æ‰€ã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'ä¿ç®¡å ´æ‰€ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
      this.closeStorageLocationModal();
      await this.loadAllMasters();
    } catch (error) {
      console.error('Failed to save storage location:', error);
      Toast.error('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  },

  // ==================== å¤§åˆ†é¡ãƒã‚¹ã‚¿ãƒ¼ ====================

  renderMajorCategories() {
    const tbody = document.getElementById('majorCategoriesBody');
    if (!tbody) return;
    if (App.masterData.majorCategories.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" class="text-muted text-center">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
      return;
    }
    tbody.innerHTML = App.masterData.majorCategories
      .map(
        (item) => `
      <tr>
        <td>${Utils.escapeHtml(item.categoryId)}</td>
        <td>${Utils.escapeHtml(item.name)}</td>
        <td>${item.displayOrder || '-'}</td>
        <td>
          <button class="btn btn-sm btn-secondary" onclick="Master.editMajorCategory('${item.categoryId}')">ç·¨é›†</button>
          <button class="btn btn-sm btn-danger" onclick="Master.deleteMajorCategory('${item.categoryId}', '${Utils.escapeHtml(item.name)}')">å‰Šé™¤</button>
        </td>
      </tr>
    `
      )
      .join('');
  },

  addMajorCategory() {
    document.getElementById('majorCategoryModalTitle').textContent = 'å¤§åˆ†é¡ã‚’è¿½åŠ ';
    document.getElementById('majorCategoryEditId').value = '';
    document.getElementById('majorCategoryName').value = '';
    document.getElementById('majorCategoryDisplayOrder').value = '';
    document.getElementById('majorCategoryModal').classList.remove('hidden');
  },

  editMajorCategory(id) {
    const item = App.masterData.majorCategories.find(c => c.categoryId === id);
    if (!item) {
      Toast.error('å¤§åˆ†é¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }
    document.getElementById('majorCategoryModalTitle').textContent = 'å¤§åˆ†é¡ã‚’ç·¨é›†';
    document.getElementById('majorCategoryEditId').value = id;
    document.getElementById('majorCategoryName').value = item.name || '';
    document.getElementById('majorCategoryDisplayOrder').value = item.displayOrder || '';
    document.getElementById('majorCategoryModal').classList.remove('hidden');
  },

  closeMajorCategoryModal() {
    document.getElementById('majorCategoryModal').classList.add('hidden');
  },

  async submitMajorCategory() {
    const editId = document.getElementById('majorCategoryEditId').value;
    const name = document.getElementById('majorCategoryName').value.trim();
    const displayOrder = document.getElementById('majorCategoryDisplayOrder').value;

    if (!name) {
      Toast.warning('ã‚«ãƒ†ã‚´ãƒªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    try {
      const data = {
        name: name,
        displayOrder: displayOrder ? parseInt(displayOrder) : undefined,
      };

      await Api.addMasterData('majorCategory', data);
      Toast.success(editId ? 'å¤§åˆ†é¡ã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'å¤§åˆ†é¡ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
      this.closeMajorCategoryModal();
      await this.loadAllMasters();
    } catch (error) {
      console.error('Failed to save major category:', error);
      Toast.error('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  },

  async deleteMajorCategory(id, name) {
    if (!confirm(`å¤§åˆ†é¡ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

    try {
      await Api.deleteMasterData('majorCategory', id);
      Toast.success('å¤§åˆ†é¡ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
      await this.loadAllMasters();
    } catch (error) {
      console.error('Failed to delete major category:', error);
      Toast.error('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  },

};

/**
 * è²©å£²æ¸ˆã¿ä¸€è¦§
 */
const SalesList = {
  products: [],
  stats: null,
  startDate: null,
  endDate: null,
  woodType: '',

  async init() {
    // æ¨¹ç¨®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’åˆæœŸåŒ–
    App.populateSelect('salesFilterWoodType', App.masterData.woodTypes, 'name', 'name', 'ã™ã¹ã¦');

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä»Šæœˆã®è²©å£²ã‚’è¡¨ç¤º
    this.setThisMonth();
    await this.loadData();
  },

  setThisMonth() {
    const now = new Date();
    this.startDate = new Date(now.getFullYear(), now.getMonth(), 1);
    this.endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);

    document.getElementById('salesStartDate').value = this.formatDateForInput(this.startDate);
    document.getElementById('salesEndDate').value = this.formatDateForInput(this.endDate);
  },

  formatDateForInput(date) {
    return date.toISOString().split('T')[0];
  },

  async loadData() {
    try {
      Loading.show();

      // è²©å£²æ¸ˆã¿è£½å“ã¨çµ±è¨ˆã‚’ä¸¦è¡Œã—ã¦å–å¾—
      const [soldProducts, stats] = await Promise.all([
        Api.call('getSoldProductsWithFilter',
          this.startDate ? this.startDate.toISOString() : null,
          this.endDate ? new Date(this.endDate.getTime() + 86400000 - 1).toISOString() : null,
          this.woodType || null
        ),
        Api.call('getSalesStats',
          this.startDate ? this.startDate.toISOString() : null,
          this.endDate ? new Date(this.endDate.getTime() + 86400000 - 1).toISOString() : null
        ),
      ]);

      this.products = soldProducts || [];
      this.stats = stats;

      this.renderTable();
      this.renderStats();
    } catch (error) {
      console.error('SalesList load error:', error);
      Toast.error('è²©å£²ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      this.products = [];
      this.stats = null;
      this.renderTable();
      this.renderStats();
    } finally {
      Loading.hide();
    }
  },

  renderTable() {
    const tbody = document.getElementById('salesTableBody');

    if (this.products.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-muted text-center">è©²å½“ã™ã‚‹è²©å£²ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>';
      return;
    }

    tbody.innerHTML = this.products.map(p => {
      const salesDate = p.salesDate ? Utils.formatDate(p.salesDate) : '-';
      const salesPrice = Utils.formatCurrency(p.actualSalesPrice || 0);
      const destination = p.salesDestination || '-';

      return `
        <tr>
          <td>${salesDate}</td>
          <td>${Utils.escapeHtml(p.productName || '-')}</td>
          <td>${Utils.escapeHtml(p.woodType || '-')}</td>
          <td class="text-right">${salesPrice}</td>
          <td>${Utils.escapeHtml(destination)}</td>
          <td>
            <button class="btn btn-sm btn-secondary" onclick="SalesList.viewProduct('${p.productId}')">è©³ç´°</button>
          </td>
        </tr>
      `;
    }).join('');
  },

  renderStats() {
    const stats = this.stats || {
      totalSales: 0,
      totalRevenue: 0,
      totalProfit: 0,
      averageProfitMargin: 0,
    };

    document.getElementById('totalSalesCount').textContent = stats.totalSales || 0;
    document.getElementById('totalRevenue').textContent = Utils.formatCurrency(stats.totalRevenue || 0);
    document.getElementById('totalProfit').textContent = Utils.formatCurrency(stats.totalProfit || 0);
    document.getElementById('avgProfitMargin').textContent = (stats.averageProfitMargin || 0) + '%';
  },

  applyFilter() {
    const startInput = document.getElementById('salesStartDate').value;
    const endInput = document.getElementById('salesEndDate').value;
    const woodType = document.getElementById('salesFilterWoodType').value;

    this.startDate = startInput ? new Date(startInput) : null;
    this.endDate = endInput ? new Date(endInput) : null;
    this.woodType = woodType;

    if (this.startDate && this.endDate && this.startDate > this.endDate) {
      Toast.warning('é–‹å§‹æ—¥ã¯çµ‚äº†æ—¥ã‚ˆã‚Šå‰ã«ã—ã¦ãã ã•ã„');
      return;
    }

    this.loadData();
  },

  resetFilter() {
    this.woodType = '';
    document.getElementById('salesFilterWoodType').value = '';
    this.setThisMonth();
    this.loadData();
  },

  viewProduct(productId) {
    App.navigateTo('product-detail', { productId });
  },

  async exportCsv() {
    try {
      Loading.show();
      const csvData = await Api.call('exportCsv', 'sales', {});

      // CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `sales_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      Toast.success('CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
    } catch (error) {
      console.error('Export CSV error:', error);
      Toast.error('CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      Loading.hide();
    }
  },
};

/**
 * ãƒ¬ãƒãƒ¼ãƒˆ
 */
const Reports = {
  async init() {
    // æ¨¹ç¨®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’åˆæœŸåŒ–
    App.populateSelect('catalogFilterWoodType', App.masterData.woodTypes, 'name', 'name', 'ã™ã¹ã¦');
  },

  async exportInventoryCsv() {
    try {
      Loading.show();
      const csvData = await Api.call('exportCsv', 'products', {});

      // CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      this.downloadCsv(csvData, `inventory_${new Date().toISOString().split('T')[0]}.csv`);
      Toast.success('åœ¨åº«ä¸€è¦§CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
    } catch (error) {
      console.error('Export inventory CSV error:', error);
      Toast.error('CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      Loading.hide();
    }
  },

  async exportSalesCsv() {
    try {
      Loading.show();
      const csvData = await Api.call('exportCsv', 'sales', {});

      // CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      this.downloadCsv(csvData, `sales_${new Date().toISOString().split('T')[0]}.csv`);
      Toast.success('è²©å£²å®Ÿç¸¾CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
    } catch (error) {
      console.error('Export sales CSV error:', error);
      Toast.error('CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      Loading.hide();
    }
  },


  downloadCsv(csvData, filename) {
    const bom = '\uFEFF';
    const blob = new Blob([bom + csvData], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  },
};

// åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', () => {
  App.init();
});
</script>
